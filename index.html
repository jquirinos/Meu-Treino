<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Treino de Hipertrofia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0a0a0a; --secondary-color: #1a1a1a; --text-color: #e0e0e0;
            --accent-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --pr-color: #f9b115;
            --input-bg: #333; --border-color: #444;
            --calendar-day-bg: #2c2c2e; --calendar-day-hover: #3a3a3c;
            --calendar-upper-color: #007bff; --calendar-lower-color: #28a745;
        }
        [data-theme="light"] {
            --primary-color: #f4f4f9; --secondary-color: #ffffff; --text-color: #0a0a0a;
            --input-bg: #e9ecef; --border-color: #dee2e6;
            --calendar-day-bg: #e9ecef; --calendar-day-hover: #d1d5db;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-color ); color: var(--text-color); margin: 0; padding: 1rem;
            line-height: 1.6; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .header-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-color); }
        h1 { text-align: left; color: var(--accent-color); border-bottom: none; margin: 0; padding-bottom: 0.5rem; font-size: 1.8rem; }
        h2, h3 { text-align: center; color: var(--accent-color); }
        .theme-switcher { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--text-color); padding: 0.5rem; }
        .main-controls, .workout-selector { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-button, .main-button, .secondary-button {
            padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold; cursor: pointer;
            border: 2px solid var(--accent-color); background-color: transparent; color: var(--accent-color);
            border-radius: 8px; transition: background-color 0.3s, color 0.3s;
        }
        .tab-button:hover, .tab-button.active { background-color: var(--accent-color); color: var(--primary-color); }
        .main-button { border-color: var(--success-color); color: var(--success-color); }
        .main-button:hover { background-color: var(--success-color); color: var(--primary-color); }
        .secondary-button { font-size: 0.8rem; padding: 0.5rem 1rem; border-color: #6c757d; color: #6c757d; }
        .secondary-button:hover { background-color: #6c757d; color: white; }
        .workout-header { text-align: center; }
        .workout-plan { display: none; } .workout-plan.active { display: block; }
        .workout-meta { color: #888; margin-top: -1rem; margin-bottom: 1rem; font-style: italic; }
        .variation-notice { background-color: var(--warning-color); color: #1a1a1a; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: bold; }
        .exercise-card { background-color: var(--secondary-color); border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); transition: background-color 0.3s; }
        .exercise-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .exercise-title { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .exercise-meta { font-size: 0.9rem; color: #aaa; }
        .pr-badge { font-size: 0.8rem; color: var(--pr-color); font-weight: bold; margin-left: 10px; }
        .sets-table { width: 100%; border-collapse: collapse; }
        .sets-table th, .sets-table td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s; }
        .sets-table th { font-size: 0.9rem; text-transform: uppercase; color: #bbb; }
        .set-row.completed td { opacity: 0.5; text-decoration: line-through; }
        .set-row.completed .input-field { text-decoration: line-through; }
        .input-field { width: 70px; padding: 0.5rem; background-color: var(--input-bg); color: var(--text-color); border: 1px solid #555; border-radius: 5px; text-align: center; font-size: 1rem; }
        .input-field::placeholder { color: #888; font-size: 0.9em; }
        .set-checkbox { width: 22px; height: 22px; cursor: pointer; }
        .timer-button { padding: 0.75rem 1rem; font-size: 1rem; font-weight: bold; cursor: pointer; border: none; border-radius: 8px; background-color: var(--success-color); color: white; transition: background-color 0.3s; min-width: 180px; }
        .timer-button.timing { background-color: var(--danger-color); cursor: not-allowed; }
        .notes-section { margin-top: 2rem; }
        .notes-section textarea { width: 100%; box-sizing: border-box; height: 80px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; font-family: inherit; font-size: 1rem; resize: vertical; }
        .finish-button { display: block; width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: bold; margin-top: 1rem; background-color: var(--accent-color); color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; }
        .finish-button:hover { opacity: 0.9; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--secondary-color); margin: auto; padding: 2rem; border: 1px solid #888; width: 95%; max-width: 800px; border-radius: 10px; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 1010; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .modal-tab-button { background: none; border: none; color: var(--text-color); padding: 1rem; font-size: 1rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .modal-tab-button.active { border-bottom-color: var(--accent-color); font-weight: bold; }
        .modal-view { display: none; } .modal-view.active { display: block; }
        .chart-controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .chart-controls select { padding: 0.5rem; background-color: var(--input-bg); color: var(--text-color); border: 1px solid #555; border-radius: 5px; }
        #history-manager, #pr-manager { max-height: 400px; overflow-y: auto; }
        .history-manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .data-io-button { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .export-button { background-color: var(--success-color); color: white; }
        .import-button { background-color: var(--info-color); color: white; }
        .history-item, .pr-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .history-item-info, .pr-item-info { font-size: 0.9rem; }
        .history-item-info strong, .pr-item-info strong { color: var(--accent-color); }
        .pr-item-details { color: var(--pr-color); font-weight: bold; }
        .history-item-notes { font-style: italic; color: #aaa; font-size: 0.85rem; margin-top: 5px; max-width: 80%; }
        .delete-btn { background: transparent; border: none; color: var(--danger-color); font-size: 1.5rem; cursor: pointer; }
        #consistency-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-weight: bold; font-size: 0.8rem; }
        .calendar-day { background-color: var(--calendar-day-bg); height: 40px; border-radius: 5px; transition: background-color 0.2s; position: relative; }
        .calendar-day.has-data:hover { background-color: var(--calendar-day-hover); }
        .calendar-day span { position: absolute; top: 5px; left: 5px; font-size: 0.7rem; }
        .workout-dots { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); display: flex; gap: 3px; }
        .dot { width: 6px; height: 6px; border-radius: 50%; }
        .dot.upper { background-color: var(--calendar-upper-color); }
        .dot.lower { background-color: var(--calendar-lower-color); }
    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
            <h1>Plano de Treino</h1>
            <button class="theme-switcher" id="theme-switcher">🌙</button>
        </div>
        <div class="main-controls" style="margin-top: 2rem;"><button class="main-button" onclick="openChartModal()">Ver Evolução</button></div>
        <div class="workout-selector">
            <button class="tab-button active" onclick="showWorkout('UpperA')">Superiores A</button>
            <button class="tab-button" onclick="showWorkout('LowerA')">Inferiores A</button>
            <button class="tab-button" onclick="showWorkout('UpperB')">Superiores B</button>
            <button class="tab-button" onclick="showWorkout('LowerB')">Inferiores B</button>
        </div>
        <div id="workout-UpperA" class="workout-plan active"></div>
        <div id="workout-LowerA" class="workout-plan"></div>
        <div id="workout-UpperB" class="workout-plan"></div>
        <div id="workout-LowerB" class="workout-plan"></div>
    </div>
    <div id="chartModal" class="modal"></div>
    <input type="file" id="import-file-input" accept=".json" style="display: none;">
<script>
    const workouts = {
        UpperA: [
            { name: 'Supino Reto com Barra', sets: 4, reps: '6-8', rest: 150 }, { name: 'Crucifixo Inclinado com Halteres', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Desenvolvimento Militar', sets: 3, reps: '8-10', rest: 120 }, { name: 'Elevação Frontal com Halteres', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Remada Curvada', sets: 4, reps: '6-8', rest: 120 }, { name: 'Rosca Direta com Barra', sets: 3, reps: '8-10', rest: 90 },
            { name: 'Tríceps Testa', sets: 3, reps: '8-10', rest: 90 },
        ],
        LowerA: [
            { name: 'Agachamento Livre', sets: 4, reps: '6-8', rest: 180 }, { name: 'Leg Press 45º', sets: 3, reps: '8-10', rest: 120 },
            { name: 'Levantamento Terra Romeno', sets: 4, reps: '8-10', rest: 120 }, { name: 'Cadeira Flexora', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Panturrilha em Pé', sets: 5, reps: '10-15', rest: 60 },
        ],
        UpperB: [
            { name: 'Barra Fixa (ou Puxada Frontal)', sets: 4, reps: '6-8', rest: 120 }, { name: 'Remada Cavalinho', sets: 3, reps: '8-10', rest: 120 },
            { name: 'Supino Inclinado com Halteres', sets: 4, reps: '8-10', rest: 120 }, { name: 'Cross Over Polia Alta', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Elevação Lateral com Halteres', sets: 4, reps: '10-15', rest: 90 }, { name: 'Crucifixo Invertido (Bent-Over)', sets: 3, reps: '12-15', rest: 90 },
            { name: 'Tríceps Corda', sets: 3, reps: '10-12', rest: 90 }, { name: 'Tríceps Francês com Halter', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Rosca Martelo', sets: 3, reps: '8-10', rest: 90 }, { name: 'Rosca Inclinada com Halteres', sets: 3, reps: '10-12', rest: 90 },
        ],
        LowerB: [
            { name: 'Levantamento Terra Convencional', sets: 4, reps: '5-6', rest: 180 }, { name: 'Elevação Pélvica com Barra', sets: 4, reps: '8-10', rest: 120 },
            { name: 'Afundo com Halteres', sets: 4, reps: '8-10', rest: 120 }, { name: 'Cadeira Extensora', sets: 3, reps: '10-12', rest: 90 },
            { name: 'Panturrilha Sentado', sets: 5, reps: '15-20', rest: 60 },
        ]
    };
    const VARIATION_THRESHOLD = 12; // Número de sessões antes de sugerir variação
    const WORKOUT_NAMES = {
        UpperA: "Superiores A",
        LowerA: "Inferiores A",
        UpperB: "Superiores B",
        LowerB: "Inferiores B"
};

    function getHistory() {
        const history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        // Garante que todas as datas sejam objetos Date, não strings
        return history.map(workout => ({
            ...workout,
            date: new Date(workout.date) 
        }));
    }

    function calculateWorkoutTime(workout) {
        const timePerSet = 45, timeBetweenExercises = 90; let totalTime = 0;
        workout.forEach(ex => { totalTime += ex.sets * timePerSet + (ex.sets - 1) * ex.rest + timeBetweenExercises; });
        return Math.round(totalTime / 60);
    }

    function getPersonalRecord(exerciseName) {
        const history = getHistory();
        let maxWeight = 0;
        history.forEach(w => w.exercises.forEach(ex => {
            if (ex.name === exerciseName) { const currentMax = Math.max(0, ...ex.sets.map(s => s.weight)); if (currentMax > maxWeight) maxWeight = currentMax; }
        }));
        return maxWeight;
    }

    function getSuggestedWeight(exerciseName) {
        const lastWeight = getPersonalRecord(exerciseName);
        if (!lastWeight) return 'kg';
        const suggestedIncrease = Math.max(lastWeight * 0.05, 2.5);
        let suggestedWeight = lastWeight + suggestedIncrease;
        suggestedWeight = Math.round(suggestedWeight * 2) / 2;
        return `Sug: ${suggestedWeight}kg`;
    }

    function createExerciseHTML(exercise) {
        const pr = getPersonalRecord(exercise.name);
        const prBadge = pr > 0 ? `<span class="pr-badge">🏆 PR: ${pr}kg</span>` : '';
        const placeholder = getSuggestedWeight(exercise.name);
        let tableRows = '';
        for (let i = 1; i <= exercise.sets; i++) {
            tableRows += `<tr class="set-row"><td>${i}</td><td><input type="number" class="input-field weight-input" placeholder="${placeholder}"></td><td><input type="checkbox" class="set-checkbox" onchange="toggleSetCompleted(this)"></td></tr>`;
        }
        return `<div class="exercise-card" data-exercise-name="${exercise.name}" data-rep-goal="${exercise.reps.split('-')[1] || exercise.reps}"><div class="exercise-header"><div><h3 class="exercise-title">${exercise.name}${prBadge}</h3><p class="exercise-meta">${exercise.sets} séries x ${exercise.reps} reps</p></div><button class="timer-button" onclick="startTimer(this, ${exercise.rest})">Iniciar Descanso (${exercise.rest}s)</button></div><table class="sets-table"><thead><tr><th>Série</th><th>Peso (kg)</th><th>Feito ✔</th></tr></thead><tbody>${tableRows}</tbody></table></div>`;
    }
    
    function toggleSetCompleted(checkbox) { checkbox.closest('.set-row').classList.toggle('completed', checkbox.checked); }

    function renderWorkouts() {
        const history = getHistory();
        for (const workoutId in workouts) {
            const container = document.getElementById(`workout-${workoutId}`);
            if (!container) continue;

            const workoutSessionCount = history.filter(w => w.workoutId === workoutId).length;
            let variationNoticeHTML = '';
            if (workoutSessionCount >= VARIATION_THRESHOLD) {
                variationNoticeHTML = `<div class="variation-notice">🧠 **Hora de Variar?** Você já fez este treino ${workoutSessionCount} vezes. Considere trocar alguns exercícios para continuar progredindo.</div>`;
            }

            const time = calculateWorkoutTime(workouts[workoutId]);
            let html = `${variationNoticeHTML}<div class="workout-header"><h2>${document.querySelector(`.tab-button[onclick="showWorkout('${workoutId}')"]`).textContent}</h2><p class="workout-meta">⏱️ Tempo Estimado: ~${time} minutos</p><button class="secondary-button" onclick="fillFromLastWorkout('${workoutId}')">Preencher com Último Treino</button></div>`;
            workouts[workoutId].forEach(ex => { html += createExerciseHTML(ex); });
            html += `<div class="notes-section"><label for="notes-${workoutId}"><h3>Notas do Treino</h3></label><textarea id="notes-${workoutId}" placeholder="Como se sentiu hoje? Alguma dor? O treino rendeu?"></textarea></div>`;
            html += `<button class="finish-button" onclick="saveWorkout('${workoutId}')">Finalizar e Salvar Treino</button>`;
            container.innerHTML = html;
        }
        document.getElementById('chartModal').innerHTML = `<div class="modal-content"><span class="close-button" onclick="closeChartModal()">&times;</span><div class="modal-tabs"><button class="modal-tab-button active" onclick="showModalView('evolution')">Evolução</button><button class="modal-tab-button" onclick="showModalView('consistency')">Consistência</button><button class="modal-tab-button" onclick="showModalView('records')">Recordes</button><button class="modal-tab-button" onclick="showModalView('history')">Histórico</button></div><div id="evolution-view" class="modal-view active"><div class="chart-controls"><select id="exerciseSelector"></select><select id="periodSelector"><option value="30">1 Mês</option><option value="90">3 Meses</option><option value="180">6 Meses</option><option value="365">1 Ano</option></select><select id="chartTypeSelector"><option value="bar">Barras</option><option value="line">Linhas</option></select></div><canvas id="evolutionChart"></canvas></div><div id="consistency-view" class="modal-view"><h3 style="text-align:center;">Frequência de Treinos</h3><div id="consistency-calendar"></div></div><div id="records-view" class="modal-view"><div id="pr-manager"></div></div><div id="history-view" class="modal-view"><div id="history-manager"></div></div></div>`;
    }

    function fillFromLastWorkout(workoutId) {
        const history = getHistory();
        const lastWorkout = history.slice().reverse().find(w => w.workoutId === workoutId);
        if (!lastWorkout) {
            alert(`Nenhum treino anterior do tipo "${document.querySelector(`.tab-button[onclick="showWorkout('${workoutId}')"]`).textContent}" foi encontrado.`);
            return;
        }
        const workoutContainer = document.getElementById(`workout-${workoutId}`);
        lastWorkout.exercises.forEach(ex => {
            const card = workoutContainer.querySelector(`.exercise-card[data-exercise-name="${ex.name}"]`);
            if (card) {
                const maxWeight = Math.max(0, ...ex.sets.map(s => s.weight));
                card.querySelectorAll('.weight-input').forEach(input => input.value = maxWeight);
            }
        });
        alert('Pesos preenchidos com base no último treino.');
    }

    function showWorkout(id) {
        document.querySelectorAll('.workout-plan').forEach(p => p.classList.remove('active'));
        document.getElementById(`workout-${id}`).classList.add('active');
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-button[onclick="showWorkout('${id}')"]`).classList.add('active');
    }

    let timerInterval;
    const notificationSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('12121212'));

    function startTimer(button, duration) {
        if (button.classList.contains('timing')) return;
        button.classList.add('timing'); let timeLeft = duration;
        timerInterval = setInterval(() => {
            timeLeft--; const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            button.textContent = `Descansando... ${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                clearInterval(timerInterval); button.classList.remove('timing');
                button.textContent = `Iniciar Descanso (${duration}s)`;
                notificationSound.play(); if (navigator.vibrate) navigator.vibrate(200);
            }
        }, 1000);
    }
    function saveWorkout(workoutId) {
        const notes = document.getElementById(`notes-${workoutId}`).value;
        const workoutData = { date: new Date().toISOString(), workoutId: workoutId, exercises: [], notes: notes };
        const container = document.getElementById(`workout-${workoutId}`);
        let newPrs = [];
        container.querySelectorAll('.exercise-card').forEach(card => {
            const name = card.dataset.exerciseName;
            const goal = parseInt(card.dataset.repGoal) || 8;
            const sets = []; let maxWeightInWorkout = 0;
            card.querySelectorAll('.set-row').forEach(row => {
                const isChecked = row.querySelector('.set-checkbox').checked;
                const weight = row.querySelector('.weight-input').value;
                if (isChecked && weight) {
                    const w = parseFloat(weight); sets.push({ weight: w, reps: goal });
                    if (w > maxWeightInWorkout) maxWeightInWorkout = w;
                }
            });
            if (sets.length > 0) {
                workoutData.exercises.push({ name: name, sets: sets });
                const oldPr = getPersonalRecord(name);
                if (maxWeightInWorkout > oldPr) newPrs.push({ name, weight: maxWeightInWorkout });
            }
        });
        if (workoutData.exercises.length === 0) { alert("Nenhum dado para salvar."); return; }
        let history = getHistory();
        history.push(workoutData);
        localStorage.setItem('workoutHistory', JSON.stringify(history));
        let alertMessage = `Treino salvo com sucesso!`;
        if (newPrs.length > 0) {
            alertMessage += "\n\n" + newPrs.map(pr => `🏆 Novo Recorde Pessoal! ${pr.name}: ${pr.weight}kg. Parabéns!`).join("\n");
        }
        alert(alertMessage);
        renderWorkouts(); showWorkout(workoutId);
    }

    const chartModal = document.getElementById('chartModal');
    let evolutionChart;

    function openChartModal() {
        chartModal.classList.add('show');
        showModalView('evolution');
        document.getElementById('exerciseSelector').onchange = updateChart;
        document.getElementById('periodSelector').onchange = updateChart;
        document.getElementById('chartTypeSelector').onchange = updateChart;
        populateSelectors(); updateChart();
    }
    function closeChartModal() { chartModal.classList.remove('show'); }

    function showModalView(viewId) {
        document.querySelectorAll('.modal-view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewId}-view`).classList.add('active');
        document.querySelectorAll('.modal-tab-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.modal-tab-button[onclick="showModalView('${viewId}')"]`).classList.add('active');

        if (viewId === 'evolution') updateChart();
        if (viewId === 'consistency') renderConsistencyCalendar();
        if (viewId === 'records') renderPrList();
        if (viewId === 'history') renderHistoryList();
    }

    function populateSelectors() {
        const history = getHistory();
        const exSet = new Set(history.flatMap(w => w.exercises.map(e => e.name)));
        const selector = document.getElementById('exerciseSelector');
        selector.innerHTML = exSet.size === 0 ? "<option>Nenhum treino salvo</option>" : "";
        exSet.forEach(name => selector.innerHTML += `<option value="${name}">${name}</option>`);
    }

    function updateChart() {
        const history = getHistory();
        const selEx = document.getElementById('exerciseSelector').value;
        const selPeriod = parseInt(document.getElementById('periodSelector').value);
        const chartType = document.getElementById('chartTypeSelector').value;
        if (!selEx || history.length === 0) { if (evolutionChart) evolutionChart.destroy(); return; }
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - selPeriod);
        const filtered = history.filter(w => w && w.date && new Date(w.date) >= cutoff).map(w => {
            const ex = w.exercises.find(e => e.name === selEx); if (!ex) return null;
            const vol = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
            const maxW = Math.max(0, ...ex.sets.map(set => set.weight));
            return { date: new Date(w.date).toLocaleDateString('pt-BR'), vol, maxW };
        }).filter(Boolean);
        const labels = [...new Set(filtered.map(d => d.date))];
        const volData = [], weightData = [];
        labels.forEach(label => {
            const dayData = filtered.filter(d => d.date === label);
            if (dayData.length > 0) {
                volData.push(dayData.reduce((sum, item) => sum + item.vol, 0));
                weightData.push(Math.max(...dayData.map(item => item.maxW)));
            }
        });
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        if (evolutionChart) evolutionChart.destroy();
        evolutionChart = new Chart(ctx, {
            type: chartType, data: { labels, datasets: [
                                { label: `Volume Total (Kg)`, data: volData, borderColor: 'rgba(0, 123, 255, 1)', backgroundColor: 'rgba(0, 123, 255, 0.5)', yAxisID: 'yVolume' },
                { label: `Carga Máxima (Kg)`, data: weightData, borderColor: 'rgba(40, 167, 69, 1)', backgroundColor: 'rgba(40, 167, 69, 0.5)', yAxisID: 'yWeight' }
            ]},
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: { color: 'var(--text-color)' } },
                    yVolume: { type: 'linear', display: true, position: 'left', ticks: { color: 'rgba(0, 123, 255, 1)' }, beginAtZero: true, title: { display: true, text: 'Volume Total', color: 'rgba(0, 123, 255, 1)'} },
                    yWeight: { type: 'linear', display: true, position: 'right', ticks: { color: 'rgba(40, 167, 69, 1)' }, beginAtZero: true, title: { display: true, text: 'Carga Máxima', color: 'rgba(40, 167, 69, 1)'}, grid: { drawOnChartArea: false } }
                },
                plugins: { legend: { labels: { color: 'var(--text-color)' } } }
            }
        });
    }

    function renderConsistencyCalendar() {
        const calendarEl = document.getElementById('consistency-calendar');
        const history = getHistory();
        calendarEl.innerHTML = ''; // Limpa o calendário

        const today = new Date();
        const month = today.getMonth();
        const year = today.getFullYear();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Adiciona cabeçalho dos dias da semana
        ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(day => {
            const headerEl = document.createElement('div');
            headerEl.className = 'calendar-header';
            headerEl.textContent = day;
            calendarEl.appendChild(headerEl);
        });

        // Adiciona dias em branco para o início do mês
        for (let i = 0; i < firstDay; i++) {
            calendarEl.appendChild(document.createElement('div'));
        }

        // Adiciona os dias do mês
        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.innerHTML = `<span>${i}</span><div class="workout-dots"></div>`;
            
            const dayWorkouts = history.filter(w => {
                const workoutDate = new Date(w.date);
                return workoutDate.getDate() === i && workoutDate.getMonth() === month && workoutDate.getFullYear() === year;
            });

            if (dayWorkouts.length > 0) {
                dayEl.classList.add('has-data');
                const dotsContainer = dayEl.querySelector('.workout-dots');
                const workoutTypes = new Set(dayWorkouts.map(w => (w.workoutId && w.workoutId.includes('Upper')) ? 'upper' : 'lower'));
                
                if (workoutTypes.has('upper')) {
                    const dot = document.createElement('div');
                    dot.className = 'dot upper';
                    dotsContainer.appendChild(dot);
                }
                if (workoutTypes.has('lower')) {
                    const dot = document.createElement('div');
                    dot.className = 'dot lower';
                    dotsContainer.appendChild(dot);
                }
            }
            calendarEl.appendChild(dayEl);
        }
    }

    function renderHistoryList() {
        const manager = document.getElementById('history-manager');
        const history = getHistory();
        manager.innerHTML = `<div class="history-manager-header"><h3>Histórico de Treinos</h3><div><button class="data-io-button export-button" onclick="exportData()">Exportar</button><button class="data-io-button import-button" onclick="importData()">Importar</button></div></div>`;
        if (history.length === 0) { manager.innerHTML += '<p>Nenhum treino salvo.</p>'; return; }
        history.slice().reverse().forEach((w, index) => {
            const originalIndex = history.length - 1 - index;
            const date = new Date(w.date).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' });
            const workoutName = WORKOUT_NAMES[w.workoutId] || w.workoutId;
            const notesHTML = w.notes ? `<p class="history-item-notes">Nota: ${w.notes}</p>` : '';
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<div class="history-item-info"><strong>${date}</strong> - <span>${workoutName}</span>${notesHTML}</div><button class="delete-btn" onclick="deleteWorkout(${originalIndex})">🗑️</button>`;
            manager.appendChild(item);
        });
    }

    function renderPrList() {
        const manager = document.getElementById('pr-manager');
        manager.innerHTML = `<h3>🏆 Recordes Pessoais (PRs)</h3>`;
        const allExercises = new Set(Object.values(workouts).flat().map(ex => ex.name));
        let prsFound = 0;
        const prList = document.createElement('div');
        const history = getHistory();

        allExercises.forEach(exName => {
            const pr = getPersonalRecord(exName);
            if (pr > 0) {
                prsFound++;
                const prWorkout = history.slice().reverse().find(w => w.exercises.some(ex => ex.name === exName && ex.sets.some(s => s.weight === pr)));
                const prDate = prWorkout ? new Date(prWorkout.date).toLocaleDateString('pt-BR') : 'N/A';
                const item = document.createElement('div');
                item.className = 'pr-item';
                item.innerHTML = `<div class="pr-item-info"><strong>${exName}</strong></div><div class="pr-item-details">${pr} kg <small>(${prDate})</small></div>`;
                prList.appendChild(item);
            }
        });
        if (prsFound === 0) {
            manager.innerHTML += '<p>Nenhum recorde registrado ainda. Continue treinando!</p>';
        } else {
            manager.appendChild(prList);
        }
    }

    function deleteWorkout(index) {
        let history = getHistory();
        const workoutDate = new Date(history[index].date).toLocaleDateString('pt-BR');
        if (confirm(`Você tem certeza que deseja deletar o treino do dia ${workoutDate}?`)) {
            history.splice(index, 1);
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            renderWorkouts();
            populateSelectors();
            showModalView('history');
        }
    }

    function exportData() {
        const history = localStorage.getItem('workoutHistory');
        if (!history || history === '[]') { alert('Não há dados para exportar.'); return; }
        const blob = new Blob([history], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'meu_historico_de_treinos.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        alert('Histórico exportado com sucesso!');
    }

    function importData() { document.getElementById('import-file-input').click(); }

    document.getElementById('import-file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedHistory = JSON.parse(e.target.result);
                if (!Array.isArray(importedHistory)) throw new Error("Formato inválido.");
                const choice = confirm("Como você deseja importar os dados?\n\nOK para MESCLAR com os dados existentes.\nCancelar para SUBSTITUIR os dados existentes.");
                if (choice) {
                    const currentHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
                    const combinedHistory = [...currentHistory, ...importedHistory];
                    const uniqueHistory = Array.from(new Map(combinedHistory.map(item => [new Date(item.date).toISOString(), item])).values());
                    localStorage.setItem('workoutHistory', JSON.stringify(uniqueHistory));
                    alert(`${importedHistory.length} registros mesclados com sucesso!`);
                } else {
                    if (confirm("ATENÇÃO: Isso apagará todos os seus dados atuais. Deseja continuar?")) {
                        localStorage.setItem('workoutHistory', JSON.stringify(importedHistory));
                        alert(`${importedHistory.length} registros importados com sucesso (substituindo os atuais)!`);
                    }
                }
                location.reload();
            } catch (error) {
                alert('Erro ao importar o arquivo. Verifique se o arquivo é um JSON válido exportado por este aplicativo.');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });

    const themeSwitcher = document.getElementById('theme-switcher');
    const doc = document.documentElement;
    
    function applyTheme(theme) {
        doc.setAttribute('data-theme', theme);
        themeSwitcher.textContent = theme === 'dark' ? '☀️' : '🌙';
        localStorage.setItem('theme', theme);
    }

    themeSwitcher.addEventListener('click', () => {
        const currentTheme = doc.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    window.onclick = function(event) { if (event.target == chartModal) closeChartModal(); }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
        renderWorkouts();
        const activeTab = document.querySelector('.tab-button.active').getAttribute('onclick').match(/'([^']+)'/)[1];
        showWorkout(activeTab);
    });
</script>

</body>
</html>
