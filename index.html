<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Treino de Hipertrofia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <style>
        :root {
            --primary-color: #0a0a0a; --secondary-color: #1a1a1a; --text-color: #e0e0e0;
            --accent-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --pr-color: #f9b115;
            --input-bg: #333; --border-color: #444;
            --calendar-day-bg: #2c2c2e; 
            --calendar-upper-color: #007bff; /* Azul */
            --calendar-lower-color: #28a745; /* Verde */
            /* Cores para Target Muscle (Melhoria) */
            --muscle-chest: #dc3545; /* Vermelho */
            --muscle-shoulders: #ffc107; /* Amarelo */
            --muscle-back: #007bff; /* Azul */
            --muscle-biceps: #28a745; /* Verde */
            --muscle-triceps: #17a2b8; /* Ciano */
            --muscle-legs: #f9b115; /* Laranja */
            --muscle-glutes: #9c27b0; /* Roxo */
            --muscle-hamstrings: #8bc34a; /* Verde Claro */
            --muscle-calves: #607d8b; /* Cinza Azulado */
            
            /* Nova vari√°vel para cor da grade do gr√°fico que muda com o tema */
            --chart-grid-color: rgba(68, 68, 68, 0.2); 
            /* Nova cor para E1RM */
            --e1rm-color: #9c27b0; 
            /* NOVO: Cor para RPE fora da faixa (7-9) */
            --rpe-warning-color: var(--warning-color);
            /* NOVO: Cor para a Linha de Progresso */
            --progress-color: var(--success-color);
            /* NOVO: Cor da linha de volume */
            --volume-line-color: var(--accent-color);
            /* NOVO: Cor para recomenda√ß√µes de progress√£o */
            --progression-color: #9c27b0;
            /* NOVO: Cor para alertas inteligentes */
            --alert-color: #ff5722;
        }
        [data-theme="light"] {
            --primary-color: #f4f4f9; --secondary-color: #ffffff; --text-color: #0a0a0a;
            --input-bg: #e9ecef; --border-color: #dee2e6;
            --calendar-day-bg: #e9ecef;
            --chart-grid-color: rgba(0, 0, 0, 0.1); /* Grade mais clara no modo claro */
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-color ); color: var(--text-color); margin: 0; padding: 1rem;
            line-height: 1.6; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 0 1rem; }
        .header-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-color); }
        .header-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        h1 { text-align: left; color: var(--accent-color); border-bottom: none; margin: 0; padding-bottom: 0.5rem; font-size: 1.8rem; }
        h2, h3 { text-align: center; color: var(--accent-color); }
        .theme-switcher { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--text-color); padding: 0.5rem; }
        .editor-button {
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            padding: 0.5rem;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .editor-button:hover {
            background-color: var(--input-bg);
            transform: scale(1.1);
        }
        .main-controls, .workout-selector { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-button, .main-button, .secondary-button {
            padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold; cursor: pointer;
            border: 2px solid var(--accent-color); background-color: transparent; color: var(--accent-color);
            border-radius: 8px; transition: background-color 0.3s, color 0.3s;
        }
        .tab-button:hover, .tab-button.active { background-color: var(--accent-color); color: var(--primary-color); }
        .main-button { border-color: var(--success-color); color: var(--success-color); }
        .main-button:hover { background-color: var(--success-color); color: var(--primary-color); }
        .secondary-button { font-size: 0.8rem; padding: 0.5rem 1rem; border-color: #6c757d; color: #6c757d; }
        .secondary-button:hover { background-color: #6c757d; color: white; }
        .workout-header { text-align: center; }
        .workout-plan { display: none; } .workout-plan.active { display: block; }
        .workout-meta { color: #888; margin-top: -1rem; margin-bottom: 1rem; font-style: italic; }
        .variation-notice, .deload-notice, .progression-notice, .smart-alert {
            padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: bold;
            cursor: pointer;
        }
        .variation-notice { background-color: var(--warning-color); color: #1a1a1a; }
		.deload-notice { background-color: var(--info-color); color: white; }
        .progression-notice { background-color: var(--progression-color); color: white; }
        .smart-alert { background-color: var(--alert-color); color: white; }
        
        /* Melhoria: Cores de Categoria e PR */
        .exercise-card { 
            background-color: var(--secondary-color); border-radius: 10px; padding: 1.5rem; 
            margin-bottom: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            transition: background-color 0.3s, border-left 0.3s;
            border-left: 5px solid var(--muscle-chest); /* Default ou Peito */
        }
        .exercise-card[data-muscle="Peito"] { border-left-color: var(--muscle-chest); }
        .exercise-card[data-muscle="Ombros"] { border-left-color: var(--muscle-shoulders); }
        .exercise-card[data-muscle="Costas"] { border-left-color: var(--muscle-back); }
        .exercise-card[data-muscle="B√≠ceps"] { border-left-color: var(--muscle-biceps); }
        .exercise-card[data-muscle="Tr√≠ceps"] { border-left-color: var(--muscle-triceps); }
        .exercise-card[data-muscle="Pernas"] { border-left-color: var(--muscle-legs); }
        .exercise-card[data-muscle="Posteriores"] { border-left-color: var(--muscle-hamstrings); }
        .exercise-card[data-muscle="Gl√∫teos"] { border-left-color: var(--muscle-glutes); }
        .exercise-card[data-muscle="Panturrilhas"] { border-left-color: var(--muscle-calves); }

        .exercise-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .exercise-title { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .exercise-meta { font-size: 0.9rem; color: #aaa; }
        /* NOVO: Estilo para a barra de intensidade */
        .intensity-bar {
            font-size: 0.85rem; 
            font-weight: bold; 
            color: var(--text-color);
            padding: 5px 10px;
            border-radius: 5px;
            background-color: var(--input-bg);
            margin-top: 5px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .intensity-bar.high { background-color: var(--danger-color); color: white; }
        .intensity-bar.low { background-color: var(--info-color); color: white; }
        /* NOVO: Estilo para Prescri√ß√£o de Carga */
        .prescribed-load {
            font-size: 1rem;
            font-weight: bold;
            color: var(--pr-color);
            padding: 5px 10px;
            border: 2px solid var(--pr-color);
            border-radius: 5px;
            background-color: rgba(249, 177, 21, 0.1);
            margin-top: 5px;
            margin-bottom: 10px;
            display: inline-block;
        }
        /* NOVO: Estilo para Recomenda√ß√µes de Progress√£o */
        .progression-recommendation {
            font-size: 0.9rem;
            color: var(--progression-color);
            padding: 8px 12px;
            border: 1px solid var(--progression-color);
            border-radius: 5px;
            background-color: rgba(156, 39, 176, 0.1);
            margin-top: 5px;
            margin-bottom: 10px;
            display: block;
        }

        .pr-badge { 
            font-size: 0.8rem; color: var(--pr-color); font-weight: bold; margin-left: 10px; 
            text-shadow: 0 0 5px rgba(249, 177, 21, 0.7); /* Efeito de brilho */
        }
        .sets-table { width: 100%; border-collapse: collapse; }
        .sets-table th, .sets-table td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s; }
        .sets-table th { font-size: 0.9rem; text-transform: uppercase; color: #bbb; }
        
        /* Melhoria: Destaque de S√©rie Completa */
        .set-row.completed td { background-color: rgba(40, 167, 69, 0.1); opacity: 0.8; }
        .set-row.completed .input-field { text-decoration: none; } /* Remove o line-through dos campos de input */
        
        .input-field { width: 50px; padding: 0.5rem; background-color: var(--input-bg); color: var(--text-color); border: 1px solid #555; border-radius: 5px; text-align: center; font-size: 1rem; }
        .input-field.weight-input { width: 70px; } /* Maior para o peso */
        .input-field.reps-input { width: 50px; } /* Menor para as reps */
        .input-field.rpe-input { 
            width: 50px; 
            /* NOVO: Estilo para RPE fora da zona ideal */
            transition: border-color 0.3s;
        } 
        .input-field.rpe-input.warning {
            border-color: var(--rpe-warning-color) !important;
            box-shadow: 0 0 5px var(--rpe-warning-color);
        }
        .input-field::placeholder { color: #888; font-size: 0.9em; }
        .set-checkbox { width: 22px; height: 22px; cursor: pointer; }
        .timer-button { 
            padding: 0.75rem 1rem; font-size: 1rem; font-weight: bold; cursor: pointer; border: none; 
            border-radius: 8px; background-color: var(--success-color); color: white; 
            transition: background-color 0.3s; min-width: 180px; 
            position: relative;
        }
        .timer-button.timing { background-color: var(--danger-color); cursor: not-allowed; }
        .timer-rest-info { font-size: 0.75rem; color: #ccc; margin-top: 5px; } /* Info de descanso */

        .notes-section { margin-top: 2rem; }
        .notes-section textarea { width: 100%; box-sizing: border-box; height: 80px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; font-family: inherit; font-size: 1rem; resize: vertical; }
        .finish-button { display: block; width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: bold; margin-top: 1rem; background-color: var(--accent-color); color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; }
        .finish-button:hover { opacity: 0.9; }

        /* Estilos do Modal (mantidos) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--secondary-color); margin: auto; padding: 2rem; border: 1px solid #888; width: 95%; max-width: 800px; border-radius: 10px; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 1010; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .modal-tab-button { background: none; border: none; color: var(--text-color); padding: 1rem; font-size: 1rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .modal-tab-button.active { border-bottom-color: var(--accent-color); font-weight: bold; }
        .modal-view { display: none; } .modal-view.active { display: block; }
        
        /* NOVO/AJUSTADO: Estilo para o Canvas dos Gr√°ficos */
        #evolutionChart, #balanceChart, #recordsUpperChart, #recordsLowerChart, #progressorsChart, #weeklyVolumeChart, #progressionChart { 
            /* Ajuste de tamanho para o gr√°fico */
            height: 350px !important; 
            max-height: 350px; 
            width: 100%; /* Garante que ele preencha o container */
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            box-sizing: border-box; /* Inclui padding e border no tamanho total */
            margin-bottom: 1.5rem; /* Espa√ßamento entre os gr√°ficos */
        }

        #history-manager, #pr-manager { max-height: 400px; overflow-y: auto; }
        .history-manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .data-io-button { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .export-button { background-color: var(--success-color); color: white; }
        .import-button { background-color: var(--info-color); color: white; }
        .history-item, .pr-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; }
        .pr-item { justify-content: flex-start; gap: 20px; }
        .pr-item-info { font-size: 0.9rem; flex-basis: 35%; }
        .pr-item-details { 
            font-size: 0.9rem; 
            font-weight: bold; 
            flex-basis: 25%;
            text-align: right;
            color: var(--pr-color);
        }
        .pr-item-e1rm {
             font-size: 0.9rem; 
             font-weight: bold; 
             flex-basis: 25%;
             text-align: right;
             color: var(--e1rm-color);
        }
        /* NOVO: Estilo para itens de progresso */
        .progress-item { justify-content: space-between; gap: 20px; }
        .progress-item-e1rm {
             font-size: 0.9rem; 
             font-weight: bold; 
             text-align: right;
             color: var(--progress-color);
        }

        .history-item-info strong, .pr-item-info strong { color: var(--accent-color); }
        .history-item-notes { font-style: italic; color: #aaa; font-size: 0.85rem; margin-top: 5px; max-width: 80%; }
        .delete-btn { background: transparent; border: none; color: var(--danger-color); font-size: 1.5rem; cursor: pointer; }

        /* --- ESTILO: CONSIST√äNCIA --- */
        #consistency-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-weight: bold; font-size: 0.8rem; }
        .calendar-day { 
            background-color: var(--calendar-day-bg); height: 40px; border-radius: 5px; 
            transition: background-color 0.2s, opacity 0.2s; position: relative; cursor: default; 
        }
        .calendar-day.has-data:hover { opacity: 0.8; }
        .calendar-day span { 
            position: absolute; top: 5px; left: 5px; font-size: 0.7rem; transition: color 0.2s; 
        }
        .calendar-day.upper-only { background-color: var(--calendar-upper-color); }
        .calendar-day.lower-only { background-color: var(--calendar-lower-color); }
        .calendar-day.mixed { 
            background: linear-gradient(45deg, var(--calendar-upper-color) 50%, var(--calendar-lower-color) 50%); 
        }
        .calendar-day.upper-only span, 
        .calendar-day.lower-only span, 
        .calendar-day.mixed span { 
            color: white; font-weight: bold; 
        }

		.focus-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9);
            z-index: 998; display: none;
        }
        .focus-overlay.active { display: block; }
        .exercise-card.in-focus {
            position: relative; z-index: 999; border: 2px solid var(--pr-color);
        }
        .focus-button {
            background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;
            opacity: 0.6; transition: opacity 0.2s;
        }
        .focus-button:hover { opacity: 1; }

        /* Melhoria: Estilos para Toast Message */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
        }
        .toast {
            background-color: var(--secondary-color); color: var(--text-color); padding: 10px 20px;
            border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0; transform: translateX(100%); transition: opacity 0.4s ease, transform 0.4s ease;
            min-width: 250px; border-left: 5px solid var(--accent-color);
        }
        .toast.show {
            opacity: 1; transform: translateX(0);
        }
        .toast-success { border-left-color: var(--success-color); }
        .toast-error { border-left-color: var(--danger-color); }
        .toast-warning { border-left-color: var(--warning-color); }
        .toast-pr { border-left-color: var(--pr-color); }
        .toast-progression { border-left-color: var(--progression-color); }
        .toast-alert { border-left-color: var(--alert-color); }

        /* --- NOVO ESTILO: MODERNIZA√á√ÉO DA ABA EVOLU√á√ÉO (GR√ÅFICOS) --- */
        .chart-mode-selector {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
        }
        .chart-mode-button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-color);
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .chart-mode-button:first-child { border-radius: 8px 0 0 8px; border-right: none; }
        .chart-mode-button:last-child { border-radius: 0 8px 8px 0; }
        .chart-mode-button.active {
            background-color: var(--accent-color);
            color: var(--primary-color);
            border-color: var(--accent-color);
        }
        .chart-controls {
            padding: 1rem;
            background-color: var(--input-bg);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        .chart-select-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }
        .chart-controls select { padding: 0.5rem; background-color: var(--secondary-color); color: var(--text-color); border: 1px solid #555; border-radius: 5px; }

        /* Estilo para o novo seletor de modo (Individual vs Semanal) */
        #evolutionModeSelector {
            display: flex;
            justify-content: center;
            gap: 0;
            margin-bottom: 1rem;
        }
        .evolution-mode-button {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
            border: 1px solid var(--accent-color);
            background-color: transparent;
            color: var(--accent-color);
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
        }
        .evolution-mode-button:first-child { border-radius: 8px 0 0 8px; }
        .evolution-mode-button:last-child { border-radius: 0 8px 8px 0; }
        .evolution-mode-button.active {
            background-color: var(--accent-color);
            color: var(--primary-color);
        }

        /* --- ESTILOS DO EDITOR DE TREINOS --- */
        .editor-container { padding: 1rem; }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px; }
        .editor-select { padding: 0.5rem; background: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 5px; font-size: 1rem; flex-grow: 1; }
        
        .editor-list { list-style: none; padding: 0; margin: 0; border: 1px solid var(--border-color); border-radius: 8px; max-height: 400px; overflow-y: auto; }
        .editor-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 10px; 
            border-bottom: 1px solid var(--border-color); background: var(--secondary-color);
            transition: background 0.2s;
        }
        .editor-item:last-child { border-bottom: none; }
        .editor-item:hover { background-color: rgba(255,255,255,0.05); }
        
        .editor-item-info { flex-grow: 1; display: flex; flex-direction: column; gap: 2px; }
        .editor-item-title { font-weight: bold; font-size: 1rem; color: var(--text-color); }
        .editor-item-details { font-size: 0.8rem; color: #888; }
        
        .editor-controls { display: flex; gap: 5px; }
        .editor-btn { 
            padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;
            display: flex; align-items: center; justify-content: center;
        }
        .btn-move { background-color: var(--info-color); color: white; }
        .btn-delete { background-color: var(--danger-color); color: white; }
        .btn-add { background-color: var(--success-color); color: white; width: 100%; padding: 10px; margin-top: 10px; font-weight: bold; }
        .btn-reset { background-color: var(--warning-color); color: #1a1a1a; padding: 0.5rem 1rem; border-radius: 5px; border: none; font-weight: bold; cursor: pointer;}

        /* Formul√°rio de Adi√ß√£o */
        .editor-form { 
            margin-top: 1.5rem; padding: 1rem; background-color: rgba(0,0,0,0.2); 
            border-radius: 8px; border: 1px solid var(--border-color); 
        }
        .form-grid { 
            display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 10px; margin-bottom: 10px; 
        }
        .form-grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        
        .editor-input { 
            width: 100%; padding: 8px; background: var(--input-bg); color: var(--text-color); 
            border: 1px solid var(--border-color); border-radius: 4px; box-sizing: border-box;
        }
        
        @media (max-width: 600px) {
            body { padding: 0; }
            .container { padding: 0.5rem; }
            h1 { font-size: 1.5rem; }
            .main-controls, .workout-selector { gap: 0.5rem; margin-bottom: 1rem; }
            .tab-button { padding: 0.5rem 0.5rem; font-size: 0.8rem; flex-grow: 1; min-width: unset; } 
            .exercise-card { padding: 1rem 0.5rem; margin-bottom: 1rem; }
            .exercise-header { flex-direction: column; align-items: stretch; gap: 0.5rem; text-align: center; }
            .exercise-header > div:first-child { text-align: center; }
            .sets-table { table-layout: fixed; }
            .sets-table th, .sets-table td { padding: 0.5rem 0.1rem; font-size: 0.8rem; }
            .sets-table th { font-size: 0.7rem; }
            .input-field { width: 30px; padding: 0.4rem; font-size: 0.8rem; }
            .input-field.weight-input { width: 45px; } 
            .input-field.reps-input { width: 30px; }
            .input-field.rpe-input { width: 30px; } /* Ajuste de responsividade para RPE */
            .timer-button { min-width: 100%; margin-top: 0.5rem; font-size: 0.9rem; }
            .modal-content { padding: 1rem 0.5rem; }
            .chart-controls, .chart-select-group { flex-direction: column; align-items: stretch; }
            .chart-controls select { width: 100%; margin-bottom: 0.5rem; }
            .modal-tabs { overflow-x: auto; white-space: nowrap; }
            .modal-tab-button { flex-shrink: 0; }

            .pr-item { flex-direction: column; align-items: flex-start; gap: 5px; }
            .pr-item-info, .pr-item-details, .pr-item-e1rm { flex-basis: 100%; text-align: left; }
            .pr-item-details { color: var(--pr-color); }
            .pr-item-e1rm { color: var(--e1rm-color); }
            
            .prescribed-load { font-size: 0.9rem; margin-top: 0; }

            /* Ajuste o seletor de modo na aba de evolu√ß√£o */
            #evolutionModeSelector { flex-direction: row; }
            .evolution-mode-button:first-child, .evolution-mode-button:last-child { border-radius: 8px; margin: 5px 0; }

             /* Responsividade do Editor */
            .form-grid, .form-grid-2 { grid-template-columns: 1fr; }
            .editor-controls { flex-direction: column; }
            .editor-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
	    <div id="deload-notice-container"></div>
        <div id="progression-notice-container"></div>
        <div id="smart-alert-container"></div>
        <div class="header-container">
            <h1>Plano de Treino</h1>
            <div class="header-controls">
                <button class="theme-switcher" id="theme-switcher">üåô</button>
                <button class="editor-button" onclick="openEditorModal()" title="Editar Treinos">‚öôÔ∏è</button>
            </div>
        </div>
        <div class="main-controls" style="margin-top: 2rem;">
            <button class="main-button" onclick="openChartModal()">Ver Evolu√ß√£o</button>
            <button class="main-button" onclick="showProgressionAnalysis()">An√°lise de Progress√£o</button>
            <button class="main-button" onclick="showSmartAlerts()">Alertas Inteligentes</button>
        </div>
        <div class="workout-selector">
            <button class="tab-button active" onclick="showWorkout('UpperA')">Superiores A</button>
            <button class="tab-button" onclick="showWorkout('LowerA')">Inferiores A</button>
            <button class="tab-button" onclick="showWorkout('UpperB')">Superiores B</button>
            <button class="tab-button" onclick="showWorkout('LowerB')">Inferiores B</button>
        </div>
        <div id="workout-UpperA" class="workout-plan active"></div>
        <div id="workout-LowerA" class="workout-plan"></div>
        <div id="workout-UpperB" class="workout-plan"></div>
        <div id="workout-LowerB" class="workout-plan"></div>
    </div>
    
    <div id="toast-container"></div>

    <div id="chartModal" class="modal"></div>
    <div id="progressionModal" class="modal"></div>
    <div id="smartAlertsModal" class="modal"></div>
    
    <div id="editorModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditorModal()">&times;</span>
            <h2 style="text-align:center; color: var(--warning-color);">Editor de Rotina</h2>
            
            <div class="editor-container">
                <div class="editor-header">
                    <label for="editorWorkoutSelect">Selecionar Treino:</label>
                    <select id="editorWorkoutSelect" class="editor-select" onchange="renderEditorList()">
                        <option value="UpperA">Superiores A</option>
                        <option value="LowerA">Inferiores A</option>
                        <option value="UpperB">Superiores B</option>
                        <option value="LowerB">Inferiores B</option>
                    </select>
                    <button class="btn-reset" onclick="resetToDefaultWorkouts()">Restaurar Padr√£o</button>
                </div>

                <ul id="editorList" class="editor-list">
                    </ul>

                <div class="editor-form">
                    <h4 style="margin-top:0; margin-bottom:10px; color: var(--accent-color);">Adicionar Novo Exerc√≠cio</h4>
                    <div class="form-grid">
                        <input type="text" id="newExName" class="editor-input" placeholder="Nome do Exerc√≠cio">
                        <input type="text" id="newExSets" class="editor-input" placeholder="S√©ries (ex: 4)">
                        <input type="text" id="newExReps" class="editor-input" placeholder="Reps (ex: 8-12)">
                    </div>
                    <div class="form-grid-2">
                        <input type="number" id="newExRest" class="editor-input" placeholder="Descanso (seg)">
                        <select id="newExMuscle" class="editor-input">
                            <option value="">Grupo Muscular...</option>
                            <option value="Peito">Peito</option>
                            <option value="Costas">Costas</option>
                            <option value="Ombros">Ombros</option>
                            <option value="B√≠ceps">B√≠ceps</option>
                            <option value="Tr√≠ceps">Tr√≠ceps</option>
                            <option value="Pernas">Pernas (Quadr√≠ceps)</option>
                            <option value="Posteriores">Posteriores</option>
                            <option value="Gl√∫teos">Gl√∫teos</option>
                            <option value="Panturrilhas">Panturrilhas</option>
                            <option value="Trap√©zio">Trap√©zio</option>
                            <option value="Adutores">Adutores</option>
                            <option value="Abdominais">Abdominais</option>
                        </select>
                    </div>
                    <button class="editor-btn btn-add" onclick="addExerciseToEditor()">+ Adicionar Exerc√≠cio</button>
                </div>
            </div>
        </div>
    </div>

    <input type="file" id="import-file-input" accept=".json" style="display: none;">

<script>
    // 1. Defini√ß√£o Padr√£o (Backup)
    const DEFAULT_WORKOUTS = {
        UpperA: [
            { name: 'Supino Inclinado com Halteres', sets: 4, reps: '8-12', rest: 60, targetMuscle: 'Peito' },
            { name: 'Supino Reto com Barra', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Peito' },
            { name: 'Crucifixo Inclinado com Halteres', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Peito' },
            { name: 'Crossover (Polia Alta)', sets: 4, reps: '10-12', rest: 60, targetMuscle: 'Peito' },
            { name: 'Tr√≠ceps Testa Cross', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Tr√≠ceps' },
            { name: 'Tr√≠ceps Corda', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Tr√≠ceps' },
            { name: 'Tr√≠ceps Coice (Unilateral)', sets: 4, reps: '8-10', rest: 90, targetMuscle: 'Tr√≠ceps' },
        ],
        LowerA: [
            { name: 'Agachamento Livre', sets: 4, reps: '8-12', rest: 120, targetMuscle: 'Pernas' },
            { name: 'Leg Press 45¬∫', sets: 4, reps: '8-12', rest: 120, targetMuscle: 'Pernas' },
            { name: 'Cadeira Extensora', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'Pernas' },
            { name: 'Afundo no Smith', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Pernas' },
            { name: 'Agachamento Hack', sets: 4, reps: '10-12', rest: 60, targetMuscle: 'Pernas' },
            { name: 'Panturrilha Sentado', sets: 5, reps: '15-20', rest: 60, targetMuscle: 'Panturrilhas' },
        ],
        UpperB: [
            { name: 'Barra Fixa (ou Puxada Frontal)', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Costas' },
            { name: 'Remada Curvada', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'Costas' },
            { name: 'Remada Baixa', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'Costas' },
            { name: 'Pullover com Haltere', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'Costas' },
            { name: 'Rosca Direta com Barra', sets: 4, reps: '10-15', rest: 90, targetMuscle: 'B√≠ceps' },
            { name: 'Rosca Scot', sets: 4, reps: '12-15', rest: 90, targetMuscle: 'B√≠ceps' },
            { name: 'Rosca Inclinada com Halteres', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'B√≠ceps' },
        ],
        LowerB: [
            { name: 'Stiff', sets: 4, reps: '10-12', rest: 90, targetMuscle: 'Posteriores' },
            { name: 'Cadeira Flexora', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Posteriores' },
            { name: 'Levantamento Terra', sets: 4, reps: '8-12', rest: 90, targetMuscle: 'Posteriores' },
            { name: 'Panturrilha em P√©', sets: 5, reps: '15-20', rest: 60, targetMuscle: 'Panturrilhas' },
            { name: 'Desenvolvimento Militar', sets: 3, reps: '8-12', rest: 90, targetMuscle: 'Ombros' },
            { name: 'Eleva√ß√£o Lateral com Halteres', sets: 4, reps: '10-12', rest: 60, targetMuscle: 'Ombros' },
            { name: 'Eleva√ß√£o Frontal com Halteres', sets: 4, reps: '10-12', rest: 60, targetMuscle: 'Ombros' },
            { name: 'Encolhimento com Halteres', sets: 4, reps: '10-12', rest: 60, targetMuscle: 'Trap√©zio' },
        ]
    };

    // 2. Carregar Treinos (LocalStorage ou Padr√£o)
    let workouts = JSON.parse(localStorage.getItem('customWorkouts')) || JSON.parse(JSON.stringify(DEFAULT_WORKOUTS));

    const VARIATION_THRESHOLD = 12; 
    const WORKOUT_NAMES = {
        UpperA: "Superiores A", LowerA: "Inferiores A", UpperB: "Superiores B", LowerB: "Inferiores B"
    };

    // Objeto de mapeamento para cores de m√∫sculos para vari√°veis CSS
    const MUSCLE_CSS_VAR_MAP = {
        'Peito': '--muscle-chest', 'Ombros': '--muscle-shoulders', 'Costas': '--muscle-back',
        'B√≠ceps': '--muscle-biceps', 'Tr√≠ceps': '--muscle-triceps', 'Pernas': '--muscle-legs',
        'Posteriores': '--muscle-hamstrings', 'Gl√∫teos': '--muscle-glutes', 'Panturrilhas': '--muscle-calves', 'Adutores': '--muscle-Adductors'
    };
    
    // Mapeamento de grupos musculares para tipo de treino
    const MUSCLE_TO_TYPE = {
        'Peito': 'upper', 'Ombros': 'upper', 'Costas': 'upper', 'B√≠ceps': 'upper', 'Tr√≠ceps': 'upper',
        'Pernas': 'lower', 'Posteriores': 'lower', 'Gl√∫teos': 'lower', 'Panturrilhas': 'lower', 'Adutores': 'lower', 'Trap√©zio': 'upper', 'Abdominais': 'lower'
    };

    // Tabela de RIR para Porcentagem da 1RM (Base Cient√≠fica)
    const rirToPercentage = {
        1: {0: 1.00, 1: 0.95, 2: 0.92, 3: 0.89, 4: 0.87, 5: 0.85},
        2: {0: 0.97, 1: 0.93, 2: 0.90, 3: 0.88, 4: 0.86, 5: 0.84},
        3: {0: 0.95, 1: 0.90, 2: 0.88, 3: 0.86, 4: 0.84, 5: 0.82},
        4: {0: 0.92, 1: 0.88, 2: 0.86, 3: 0.84, 4: 0.82, 5: 0.80},
        5: {0: 0.90, 1: 0.86, 2: 0.84, 3: 0.82, 4: 0.80, 5: 0.78},
        6: {0: 0.88, 1: 0.84, 2: 0.82, 3: 0.80, 4: 0.78, 5: 0.76},
        7: {0: 0.86, 1: 0.82, 2: 0.80, 3: 0.78, 4: 0.76, 5: 0.74},
        8: {0: 0.84, 1: 0.80, 2: 0.78, 3: 0.76, 4: 0.74, 5: 0.72},
        9: {0: 0.82, 1: 0.78, 2: 0.76, 3: 0.74, 4: 0.72, 5: 0.70},
        10: {0: 0.80, 1: 0.76, 2: 0.74, 3: 0.72, 4: 0.70, 5: 0.68},
        11: {0: 0.78, 1: 0.74, 2: 0.72, 3: 0.70, 4: 0.68, 5: 0.66},
        12: {0: 0.76, 1: 0.72, 2: 0.70, 3: 0.68, 4: 0.66, 5: 0.64},
        15: {0: 0.70, 1: 0.66, 2: 0.64, 3: 0.62, 4: 0.60, 5: 0.58},
        20: {0: 0.60, 1: 0.58, 2: 0.56, 3: 0.54, 4: 0.52, 5: 0.50}
    };

    // Vari√°veis Globais de Gr√°fico
    let evolutionChart;
    let balanceChart; 
    let recordsUpperChart; 
    let recordsLowerChart; 
    let progressorsChart; 
    let weeklyVolumeChart;
    let progressionChart;
    let currentEvolutionMode = 'exercise';
    let currentEvolutionView = 'individual';
    let currentRecordsMode = 'weight';
    
    // Base Chart Options para visual moderno e tema din√¢mico
    let BASE_CHART_OPTIONS = {};
    
    // Fun√ß√£o para obter as cores din√¢micas do CSS
    function getCssVariable(name) {
        return getComputedStyle(document.documentElement).getPropertyValue(name).trim() || '#ccc'; 
    }
    
    // Fun√ß√£o para atualizar as op√ß√µes base do gr√°fico com cores din√¢micas
    function updateBaseChartOptions() {
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');
        const borderColor = getCssVariable('--border-color');

        BASE_CHART_OPTIONS = {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { 
                mode: 'index', 
                intersect: false 
            },
            plugins: {
                legend: {
                    labels: {
                        color: textColor,
                        font: { size: 14 }
                    }
                },
                tooltip: {
                    backgroundColor: getCssVariable('--secondary-color'),
                    titleColor: getCssVariable('--accent-color'),
                    bodyColor: textColor,
                    borderColor: borderColor,
                    borderWidth: 1,
                    cornerRadius: 5
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: textColor,
                        font: { size: 12 }
                    },
                    grid: {
                        color: gridColor,
                        borderColor: borderColor
                    }
                }
            }
        };
    }
    
    // FUN√á√ÉO MELHORADA: TOAST MESSAGE 
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);

        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500);
        }, duration);
    }

    // L√ìGICA PARA O MODO FOCO 
    let focusOverlay;
    function createFocusOverlay() {
        if (document.getElementById('focus-overlay')) return;
        focusOverlay = document.createElement('div');
        focusOverlay.id = 'focus-overlay';
        focusOverlay.className = 'focus-overlay';
        focusOverlay.onclick = () => toggleFocus(null, true);
        document.body.appendChild(focusOverlay);
    }
    function toggleFocus(button, forceOff = false) {
        const activeCard = document.querySelector('.exercise-card.in-focus');
        if (forceOff || activeCard) {
            if(activeCard) activeCard.classList.remove('in-focus');
            focusOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        } else {
            const card = button.closest('.exercise-card');
            card.classList.add('in-focus');
            focusOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; 
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }

    function getHistory() {
        const history = JSON.parse(localStorage.getItem('workoutHistory') || '[]');
        return history.map(workout => ({
            ...workout,
            date: new Date(workout.date) 
        }));
    }

    function calculateWorkoutTime(workout) {
        const timePerSet = 45, timeBetweenExercises = 90; let totalTime = 0;
        workout.forEach(ex => { totalTime += ex.sets * timePerSet + (ex.sets - 1) * ex.rest + timeBetweenExercises; });
        return Math.round(totalTime / 60);
    }

    function getExerciseInfo(name) {
        for (const workoutId in workouts) {
            const info = workouts[workoutId].find(ex => ex.name === name);
            if (info) return info;
        }
        return null;
    }

    // Fun√ß√£o para calcular 1RM Estimado (Epley Formula)
    function calculateE1RM(weight, reps) {
        if (weight <= 0 || reps <= 0) return 0;
        const e1rm = weight * (1 + reps / 30);
        return parseFloat(e1rm.toFixed(2));
    }
    
    function getPersonalRecord(exerciseName) {
        const history = getHistory();
        let maxWeight = 0;
        history.forEach(w => w.exercises.forEach(ex => {
            if (ex.name === exerciseName) { 
                const currentMax = Math.max(0, ...ex.sets.map(s => s.weight)); 
                if (currentMax > maxWeight) maxWeight = currentMax; 
            }
        }));
        return maxWeight;
    }
    
    function getLastWorkoutRpe(exerciseName) {
        const history = getHistory();
        for (let i = history.length - 1; i >= 0; i--) {
            const workout = history[i];
            const exercise = workout.exercises.find(ex => ex.name === exerciseName);
            
            if (exercise) {
                const completedSets = exercise.sets.filter(s => s.rpe !== null);
                if (completedSets.length > 0) {
                    const sumRpe = completedSets.reduce((sum, s) => sum + s.rpe, 0);
                    const avgRpe = sumRpe / completedSets.length;
                    return avgRpe.toFixed(1); 
                }
            }
        }
        return null;
    }
    
    function getMaxE1RM(exerciseName) {
        const history = getHistory();
        let maxE1RM = 0;
        history.forEach(w => w.exercises.forEach(ex => {
            if (ex.name === exerciseName) { 
                ex.sets.forEach(set => {
                    if (set.weight > 0 && set.reps > 0) {
                        const currentE1RM = calculateE1RM(set.weight, set.reps);
                        if (currentE1RM > maxE1RM) maxE1RM = currentE1RM;
                    }
                });
            }
        }));
        return maxE1RM;
    }
    
    // Fun√ß√£o para calcular a Carga Prevista (Prescribed Load)
    function getPrescribedLoad(exerciseName) {
        const maxE1RM = getMaxE1RM(exerciseName);
        if (maxE1RM === 0) return null;

        const info = getExerciseInfo(exerciseName);
        if (!info) return null;

        const repsRange = info.reps.split('-').map(r => parseInt(r));
        let targetReps;
        if (repsRange.length === 2) {
            targetReps = Math.round((repsRange[0] + repsRange[1]) / 2);
        } else {
            targetReps = parseInt(info.reps);
        }
        
        const effectiveReps = Math.min(targetReps, 15); 
        const targetRIR = 2; // RPE 8

        let percentage = null;
        const availableReps = Object.keys(rirToPercentage).map(r => parseInt(r));
        let bestMatchReps = availableReps[0];
        let minDiff = Math.abs(effectiveReps - bestMatchReps);
        
        availableReps.forEach(r => {
            const diff = Math.abs(effectiveReps - r);
            if (diff < minDiff) {
                minDiff = diff;
                bestMatchReps = r;
            }
        });

        if (rirToPercentage[bestMatchReps] && rirToPercentage[bestMatchReps][targetRIR] !== undefined) {
            percentage = rirToPercentage[bestMatchReps][targetRIR];
        }

        if (!percentage) return null;

        let prescribedLoad = maxE1RM * percentage;
        prescribedLoad = Math.round(prescribedLoad * 2) / 2; // Arredonda para 0.5kg mais pr√≥ximo

        if (prescribedLoad <= 0) return null;

        return prescribedLoad.toFixed(1); 
    }
    
    // Fun√ß√£o para obter TODOS os recordes pessoais (PRs) com tipo de m√∫sculo e E1RM
    function getAllPersonalRecords() {
        const history = getHistory();
        const prs = {}; 

        history.forEach(w => {
            const workoutDate = new Date(w.date);
            w.exercises.forEach(ex => {
                const exInfo = getExerciseInfo(ex.name);
                const muscleType = exInfo ? MUSCLE_TO_TYPE[exInfo.targetMuscle] : null;

                if (muscleType) {
                    let maxW = 0;
                    let maxE1RM = 0;
                    
                    ex.sets.forEach(set => {
                        const currentE1RM = calculateE1RM(set.weight, set.reps);
                        
                        if (currentE1RM > maxE1RM) { maxE1RM = currentE1RM; }
                        if (set.weight > maxW) { maxW = set.weight; }
                    });

                    const existingPr = prs[ex.name];
                    
                    if (!existingPr) {
                        prs[ex.name] = { 
                            max_weight: maxW, max_e1rm: maxE1RM, date_raw: w.date,
                            date: workoutDate.toLocaleDateString('pt-BR'), type: muscleType
                        };
                    } else {
                        let shouldUpdate = false;
                        
                        if (maxW > existingPr.max_weight) { existingPr.max_weight = maxW; shouldUpdate = true; }
                        if (maxE1RM > existingPr.max_e1rm) { existingPr.max_e1rm = maxE1RM; shouldUpdate = true; }
                        
                        if (maxW === existingPr.max_weight && workoutDate > new Date(existingPr.date_raw)) { shouldUpdate = true; }
                        if (maxE1RM === existingPr.max_e1rm && workoutDate > new Date(existingPr.date_raw)) { shouldUpdate = true; }

                        if (shouldUpdate) {
                            existingPr.date_raw = w.date;
                            existingPr.date = workoutDate.toLocaleDateString('pt-BR');
                        }
                    }
                }
            });
        });

        return Object.entries(prs)
            .map(([name, data]) => ({ name, weight: data.max_weight, e1rm: data.max_e1rm, date: data.date, type: data.type }))
            .sort((a, b) => b.e1rm - a.e1rm); 
    }
    
    // Fun√ß√£o para calcular o aumento de E1RM nos √∫ltimos 60 dias
    function getE1RMTrends() {
        const history = getHistory();
        const trends = {}; 
        
        const exerciseData = {};
        history.forEach(w => w.exercises.forEach(ex => {
            ex.sets.forEach(set => {
                if (set.weight > 0 && set.reps > 0) {
                    const e1rm = calculateE1RM(set.weight, set.reps);
                    if (!exerciseData[ex.name]) exerciseData[ex.name] = [];
                    // Adiciona o maior E1RM do treino para aquele exerc√≠cio
                    const currentMax = Math.max(0, ...(exerciseData[ex.name].length > 0 ? [exerciseData[ex.name].pop().e1rm] : [0]), e1rm);
                    // Adiciona o maior E1RM do dia para evitar m√∫ltiplas entradas no mesmo dia
                    exerciseData[ex.name].push({ date: new Date(w.date), e1rm: currentMax });
                }
            });
        }));

        const TREND_WINDOW_DAYS = 60; // 8 semanas
        
        for (const name in exerciseData) {
            const data = exerciseData[name].sort((a, b) => a.date - b.date); 
            if (data.length < 2) continue;

            const latestEntry = data[data.length - 1];
            
            const latestDate = latestEntry.date;
            const baselineCutoffDate = new Date(latestDate);
            baselineCutoffDate.setDate(latestDate.getDate() - TREND_WINDOW_DAYS);

            let baselineEntry = data[0]; 
            
            // Encontra a melhor linha de base: o √∫ltimo registro *antes* da janela de 60 dias
            for (let i = 0; i < data.length; i++) {
                if (data[i].date < baselineCutoffDate) {
                    baselineEntry = data[i];
                } else {
                    break;
                }
            }
            
            const latestE1RM = latestEntry.e1rm;
            const baselineE1RM = baselineEntry.e1rm;
            
            if (latestE1RM > baselineE1RM && baselineE1RM > 0) {
                const increase = latestE1RM - baselineE1RM;
                const percentage = (increase / baselineE1RM) * 100;
                
                trends[name] = {
                    latestE1RM: parseFloat(latestE1RM.toFixed(1)),
                    baselineE1RM: parseFloat(baselineE1RM.toFixed(1)),
                    increase: parseFloat(increase.toFixed(1)),
                    percentage: parseFloat(percentage.toFixed(1)),
                    // Usa a data do baseline para mostrar o per√≠odo de progresso
                    baselineDate: baselineEntry.date.toLocaleDateString('pt-BR') 
                };
            }
        }
        
        return Object.entries(trends)
            .map(([name, data]) => ({ name, ...data }))
            .sort((a, b) => b.increase - a.increase); 
    }
    
    // Fun√ß√£o para renderizar o gr√°fico de Maiores Progressos
    function renderProgressorsChart() {
        const progressors = getE1RMTrends();
        const chartCanvas = document.getElementById('progressorsChart');

        if (progressorsChart) progressorsChart.destroy();

        if (progressors.length === 0) {
            chartCanvas.style.display = 'none';
            let msgElement = document.getElementById(`progressorsChart-nodata`);
            if (!msgElement) {
                msgElement = document.createElement('p');
                msgElement.id = `progressorsChart-nodata`;
                msgElement.style.cssText = 'text-align:center; color: var(--text-color); margin-top: 15px;';
                chartCanvas.parentNode.insertBefore(msgElement, chartCanvas);
            }
            msgElement.textContent = `Nenhum progresso de E1RM registrado nos √∫ltimos 60 dias.`;
            return;
        }

        let msgElement = document.getElementById(`progressorsChart-nodata`);
        if (msgElement) msgElement.remove();

        chartCanvas.style.display = 'block';

        const top10 = progressors.slice(0, 10).reverse(); // Reverte para a barra maior ficar em cima
        const labels = top10.map(p => p.name);
        const data = top10.map(p => p.increase); // Plota o aumento (aumento absoluto)
        
        updateBaseChartOptions();
        const progressColor = getCssVariable('--progress-color');
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');

        const ctx = chartCanvas.getContext('2d');
        
        const chartOptions = JSON.parse(JSON.stringify(BASE_CHART_OPTIONS));
        
        chartOptions.plugins.legend.display = false;
        chartOptions.indexAxis = 'y'; // Transforma em gr√°fico de barras horizontal

        chartOptions.scales = {
            x: {
                ...chartOptions.scales.x,
                position: 'bottom',
                beginAtZero: true,
                title: { 
                    display: true, 
                    text: 'Aumento Absoluto de E1RM (kg)', 
                    color: progressColor 
                },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            },
            y: { 
                type: 'category', 
                ticks: { 
                    color: textColor 
                },
                grid: { drawOnChartArea: false } 
            }
        };
        
        const datasets = [{
            label: 'Aumento de E1RM (kg)',
            data: data,
            backgroundColor: progressColor + 'CC', 
            borderColor: progressColor,
            borderWidth: 2,
            borderRadius: 5,
            hoverBackgroundColor: progressColor,
        }];
        
        progressorsChart = new Chart(ctx, {
            type: 'bar', 
            data: { labels, datasets },
            options: chartOptions
        });
    }

    // Fun√ß√£o para renderizar a lista de PRs
    function renderPRs() {
        const prManager = document.getElementById('pr-manager');
        const prs = getAllPersonalRecords();
        prManager.innerHTML = ''; 

        if (prs.length === 0) {
            prManager.innerHTML = `<p style="text-align:center; color: var(--text-color); margin-top: 15px;">Nenhum Recorde Pessoal registrado ainda.</p>`;
            return;
        }

        let html = '<h4 style="text-align:center; margin-top: 2rem; color: var(--text-color); border-top: 1px solid var(--border-color); padding-top: 1rem;">Lista Completa de Recordes</h4>';
        html += '<div style="display: flex; justify-content: flex-start; gap: 20px; font-weight: bold; border-bottom: 2px solid var(--border-color); padding-bottom: 5px; margin-bottom: 5px;">'
        html += '<div style="flex-basis: 35%;">Exerc√≠cio</div>'
        html += `<div style="flex-basis: 25%; text-align: right; color: var(--pr-color);">PR Peso</div>`
        html += `<div style="flex-basis: 25%; text-align: right; color: var(--e1rm-color);">E1RM M√°x</div>`
        html += '</div>';

        prs.forEach(pr => {
            html += `
                <div class="pr-item">
                    <div class="pr-item-info">
                        <strong>${pr.name}</strong>
                        <div class="history-item-notes">
                            (${pr.type === 'upper' ? 'Superiores' : 'Inferiores'}) - ${pr.date}
                        </div>
                    </div>
                    <div class="pr-item-details">
                        ${pr.weight} kg
                    </div>
                    <div class="pr-item-e1rm">
                        ${pr.e1rm.toFixed(2)} kg
                    </div>
                </div>
            `;
        });

        prManager.innerHTML = html;
    }

    // Fun√ß√£o para alternar o tipo de dado do gr√°fico de recordes
    function toggleRecordsChartMode(mode) {
        currentRecordsMode = mode;
        document.querySelectorAll('.chart-record-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.chart-record-button[data-mode="${mode}"]`).classList.add('active');
        
        renderRecordsChart('upper'); 
        renderRecordsChart('lower');
    }

    // Fun√ß√£o para renderizar o gr√°fico de Recordes Pessoais por tipo
    function renderRecordsChart(type) {
        const allPrs = getAllPersonalRecords();
        const filteredPrs = allPrs.filter(pr => pr.type === type)
            .sort((a, b) => (currentRecordsMode === 'weight' ? b.weight - a.weight : b.e1rm - a.e1rm))
            .slice(0, 10); 
        
        const chartId = type === 'upper' ? 'recordsUpperChart' : 'recordsLowerChart';
        const chartCanvas = document.getElementById(chartId);
        
        const currentChart = type === 'upper' ? recordsUpperChart : recordsLowerChart;
        if (currentChart) currentChart.destroy();

        const dataKey = currentRecordsMode === 'weight' ? 'weight' : 'e1rm';
        const unitLabel = currentRecordsMode === 'weight' ? 'Peso M√°ximo (kg)' : 'E1RM M√°ximo (kg)';
        const titleMode = currentRecordsMode === 'weight' ? 'Peso M√°ximo' : 'E1RM M√°ximo';
        const titleText = `${type === 'upper' ? 'Recordes de Superiores' : 'Recordes de Inferiores'} (${titleMode} Top 10)`;
        
        const titleElement = chartCanvas.previousElementSibling;
        if (titleElement && titleElement.tagName === 'H4') {
            titleElement.textContent = titleText;
        }

        if (filteredPrs.length === 0) {
            chartCanvas.style.display = 'none';
            let msgElement = document.getElementById(`${chartId}-nodata`);
            if (!msgElement) {
                msgElement = document.createElement('p');
                msgElement.id = `${chartId}-nodata`;
                msgElement.style.cssText = 'text-align:center; color: var(--text-color); margin-top: 15px;';
                chartCanvas.parentNode.insertBefore(msgElement, chartCanvas);
            }
            msgElement.textContent = `Nenhum PR de ${type === 'upper' ? 'Superiores' : 'Inferiores'} registrado.`;
            return;
        }

        let msgElement = document.getElementById(`${chartId}-nodata`);
        if (msgElement) msgElement.remove();

        chartCanvas.style.display = 'block';

        const labels = filteredPrs.map(pr => pr.name);
        const data = filteredPrs.map(pr => dataKey === 'e1rm' ? parseFloat(pr[dataKey].toFixed(2)) : pr[dataKey]);
        
        updateBaseChartOptions();
        const typeColor = currentRecordsMode === 'weight' 
            ? (type === 'upper' ? getCssVariable('--calendar-upper-color') : getCssVariable('--calendar-lower-color'))
            : getCssVariable('--e1rm-color'); 
        
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');

        const ctx = chartCanvas.getContext('2d');
        
        const chartOptions = JSON.parse(JSON.stringify(BASE_CHART_OPTIONS));
        
        chartOptions.plugins.legend.display = false;

        chartOptions.scales = {
            x: {
                ...chartOptions.scales.x,
                ticks: { 
                    color: textColor,
                    font: { size: 12 },
                    maxRotation: 45,
                    minRotation: 45 
                },
                grid: { drawOnChartArea: false }
            },
            y: { 
                type: 'linear', 
                display: true, 
                position: 'left', 
                beginAtZero: false, 
                suggestedMin: Math.floor(Math.min(...data) * 0.9 / 10) * 10,
                title: { 
                    display: true, 
                    text: unitLabel, 
                    color: typeColor 
                },
                ticks: { 
                    color: textColor 
                }, 
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            }
        };

        const datasets = [{
            label: unitLabel,
            data: data,
            backgroundColor: typeColor + 'CC', 
            borderColor: typeColor,
            borderWidth: 2,
            borderRadius: 5,
            hoverBackgroundColor: typeColor,
        }];
        
        const newChart = new Chart(ctx, {
            type: 'bar', 
            data: { labels, datasets },
            options: chartOptions
        });

        if (type === 'upper') {
            recordsUpperChart = newChart;
        } else {
            recordsLowerChart = newChart;
        }
    }

    function getSuggestedWeight(exerciseName) {
        const prescribedLoad = getPrescribedLoad(exerciseName);
        if (prescribedLoad !== null) {
            return `[${prescribedLoad} kg]`; 
        }

        const lastWeight = getPersonalRecord(exerciseName);
        if (!lastWeight) return 'kg';
        const suggestedIncrease = Math.max(lastWeight * 0.025, 1.25); 
        let suggestedWeight = lastWeight + suggestedIncrease;
        suggestedWeight = Math.round(suggestedWeight * 2) / 2;
        
        return `Sug: ${suggestedWeight}kg`; 
    }

    // FUN√á√ÉO DE CRIA√á√ÉO DE EXERC√çCIO
    function createExerciseHTML(exercise) {
        const pr = getPersonalRecord(exercise.name);
        const lastRpe = getLastWorkoutRpe(exercise.name);
        
        const prescribedLoad = getPrescribedLoad(exercise.name);
        const placeholderText = getSuggestedWeight(exercise.name);
        const isPrescribed = placeholderText.startsWith('[') && prescribedLoad;

        const prBadge = pr > 0 ? `<span class="pr-badge">üèÜ PR: ${pr}kg</span>` : '';
        
        const defaultReps = exercise.reps.split('-').pop();
        
        const loadPrescription = isPrescribed 
            ? `<span class="prescribed-load">Carga Prevista (RPE 8): ${prescribedLoad} kg</span>` 
            : '';

        let intensityBar = '';
        if (lastRpe) {
            const rir = (10 - parseFloat(lastRpe)).toFixed(1);
            let barClass = '';
            if (parseFloat(lastRpe) < 7) barClass = 'low';
            if (parseFloat(lastRpe) > 9) barClass = 'high';

            intensityBar = `<span class="intensity-bar ${barClass}">√öltimo RPE: ${lastRpe} (RIR: ${rir})</span>`;
        }

        // Adicionar recomenda√ß√µes de progress√£o
        const progressionRecommendation = getProgressionRecommendation(exercise.name);
        const progressionHTML = progressionRecommendation 
            ? `<div class="progression-recommendation">üí° ${progressionRecommendation}</div>` 
            : '';

        let tableRows = '';
        for (let i = 1; i <= exercise.sets; i++) {
            const currentPlaceholder = isPrescribed ? prescribedLoad : placeholderText.replace('Sug: ', '').replace('kg', '');
            
            tableRows += `
                <tr class="set-row">
                    <td>${i}</td>
                    <td><input type="number" class="input-field weight-input" placeholder="${currentPlaceholder}" onblur="autoCompleteSet(this)" min="0" step="0.5"></td>
                    <td><input type="number" class="input-field reps-input" value="${defaultReps}" onblur="autoCompleteSet(this)" min="1"></td>
                    <td><input type="number" class="input-field rpe-input" placeholder="RPE" min="6" max="10" step="0.5" onkeyup="checkRpeRange(this)" onblur="autoCompleteSet(this)"></td>
                    <td><input type="checkbox" class="set-checkbox" onchange="toggleSetCompleted(this)"></td>
                </tr>
            `;
        }
        
        return `
            <div class="exercise-card" data-exercise-name="${exercise.name}" data-muscle="${exercise.targetMuscle}">
                <div class="exercise-header">
                    <div>
                        <h3 class="exercise-title">${exercise.name}${prBadge}</h3>
                        <p class="exercise-meta">${exercise.sets} s√©ries x ${exercise.reps} reps (${exercise.targetMuscle})</p>
                        ${loadPrescription} 
                        ${intensityBar} 
                        ${progressionHTML}
                    </div>
                    <div>
                        <button class="focus-button" onclick="toggleFocus(this)">üëÅÔ∏è</button>
                        <button class="timer-button" onclick="startTimer(this, ${exercise.rest})">
                            Iniciar Descanso
                        </button>
                        <div class="timer-rest-info">(${exercise.rest}s)</div>
                    </div>
                </div>
                <table class="sets-table">
                    <thead>
                        <tr>
                            <th>S√©rie</th>
                            <th>Peso (kg)</th>
                            <th>Reps</th>
                            <th>RPE</th> 
                            <th>Feito ‚úî</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        `;
    }
    
    // Fun√ß√£o para obter recomenda√ß√µes de progress√£o
    function getProgressionRecommendation(exerciseName) {
        const history = getHistory();
        const exerciseHistory = history
            .map(w => w.exercises.find(ex => ex.name === exerciseName))
            .filter(ex => ex)
            .slice(-5); // √öltimos 5 treinos
        
        if (exerciseHistory.length < 3) return null;
        
        // Analisa tend√™ncia de progresso
        const e1rmTrend = [];
        exerciseHistory.forEach(ex => {
            const maxE1RM = Math.max(...ex.sets.map(set => calculateE1RM(set.weight, set.reps)));
            e1rmTrend.push(maxE1RM);
        });
        
        // Calcula se est√° estagnado
        const lastThree = e1rmTrend.slice(-3);
        const isStagnant = lastThree.every(val => val <= lastThree[0] * 1.02); // Menos de 2% de aumento nos √∫ltimos 3 treinos
        
        if (isStagnant) {
            const recommendations = [
                "Tente aumentar 2.5kg na pr√≥xima sess√£o",
                "Considere mudar para varia√ß√£o do exerc√≠cio",
                "Aumente o volume (1 s√©rie extra)",
                "Diminua o descanso entre s√©ries",
                "Experimente t√©cnica de intensidade (drop sets)"
            ];
            return recommendations[Math.floor(Math.random() * recommendations.length)];
        }
        
        // Se est√° progredindo bem
        if (e1rmTrend[e1rmTrend.length - 1] > e1rmTrend[0] * 1.05) { // Mais de 5% de aumento
            return "Continue com a progress√£o atual!";
        }
        
        return null;
    }
    
    // Fun√ß√£o para analisar progress√£o geral
    function analyzeProgression() {
        const history = getHistory();
        if (history.length < 4) return null;
        
        const analysis = {
            progressing: [],
            stagnating: [],
            recommendations: []
        };
        
        // Analisa cada exerc√≠cio
        const allExercises = [...new Set(history.flatMap(w => w.exercises.map(ex => ex.name)))];
        
        allExercises.forEach(exerciseName => {
            const exerciseHistory = history
                .map(w => w.exercises.find(ex => ex.name === exerciseName))
                .filter(ex => ex)
                .slice(-4); // √öltimos 4 treinos
            
            if (exerciseHistory.length < 3) return;
            
            const e1rmTrend = exerciseHistory.map(ex => 
                Math.max(...ex.sets.map(set => calculateE1RM(set.weight, set.reps)))
            );
            
            const first = e1rmTrend[0];
            const last = e1rmTrend[e1rmTrend.length - 1];
            const progress = ((last - first) / first) * 100;
            
            if (progress > 5) {
                analysis.progressing.push({
                    name: exerciseName,
                    progress: progress.toFixed(1)
                });
            } else if (progress < 2) {
                analysis.stagnating.push({
                    name: exerciseName,
                    progress: progress.toFixed(1)
                });
            }
        });
        
        // Gera recomenda√ß√µes gerais
        if (analysis.stagnating.length > analysis.progressing.length) {
            analysis.recommendations.push("Considere uma semana de deload");
            analysis.recommendations.push("Mude a ordem dos exerc√≠cios no treino");
        }
        
        if (analysis.progressing.length >= 3) {
            analysis.recommendations.push("Continue com o programa atual - est√° funcionando bem!");
        }
        
        return analysis;
    }
    
    // Fun√ß√£o para mostrar an√°lise de progress√£o
    function showProgressionAnalysis() {
        const analysis = analyzeProgression();
        const modal = document.getElementById('progressionModal');
        
        if (!analysis) {
            showToast("Precisa de mais dados para an√°lise de progress√£o (m√≠nimo 4 treinos)", "warning");
            return;
        }
        
        let html = `
            <div class="modal-content">
                <span class="close-button" onclick="closeProgressionModal()">&times;</span>
                <h2 style="text-align:center; color: var(--progression-color);">An√°lise de Progress√£o</h2>
                
                <div style="display: flex; justify-content: space-around; margin: 2rem 0;">
                    <div style="text-align: center;">
                        <h3 style="color: var(--success-color);">${analysis.progressing.length}</h3>
                        <p>Exerc√≠cios Progredindo</p>
                    </div>
                    <div style="text-align: center;">
                        <h3 style="color: var(--warning-color);">${analysis.stagnating.length}</h3>
                        <p>Exerc√≠cios Estagnados</p>
                    </div>
                </div>
        `;
        
        if (analysis.progressing.length > 0) {
            html += `<h3>‚úÖ Exerc√≠cios com Boa Progress√£o:</h3><ul>`;
            analysis.progressing.forEach(ex => {
                html += `<li><strong>${ex.name}</strong>: +${ex.progress}%</li>`;
            });
            html += `</ul>`;
        }
        
        if (analysis.stagnating.length > 0) {
            html += `<h3>‚ö†Ô∏è Exerc√≠cios Estagnados:</h3><ul>`;
            analysis.stagnating.forEach(ex => {
                html += `<li><strong>${ex.name}</strong>: ${ex.progress}%</li>`;
            });
            html += `</ul>`;
        }
        
        if (analysis.recommendations.length > 0) {
            html += `<h3>üí° Recomenda√ß√µes:</h3><ul>`;
            analysis.recommendations.forEach(rec => {
                html += `<li>${rec}</li>`;
            });
            html += `</ul>`;
        }
        
        html += `</div>`;
        
        modal.innerHTML = html;
        modal.classList.add('show');
    }
    
    // Fun√ß√£o para fechar modal de progress√£o
    function closeProgressionModal() {
        document.getElementById('progressionModal').classList.remove('show');
    }
    
    function checkRpeRange(input) {
        const rpe = parseFloat(input.value);
        if (rpe && (rpe < 7 || rpe > 9)) {
            input.classList.add('warning');
            input.title = "RPE fora da faixa ideal (7-9) para Hipertrofia.";
        } else {
            input.classList.remove('warning');
            input.title = "";
        }
    }
    
    function autoCompleteSet(input) {
        if (input.classList.contains('rpe-input')) {
            checkRpeRange(input);
        }

        const row = input.closest('.set-row');
        const weightInput = row.querySelector('.weight-input');
        const repsInput = row.querySelector('.reps-input');
        const rpeInput = row.querySelector('.rpe-input');
        const checkbox = row.querySelector('.set-checkbox');
        
        if (weightInput.value.trim() !== '' && repsInput.value.trim() !== '' && rpeInput.value.trim() !== '') {
            checkbox.checked = true;
            toggleSetCompleted(checkbox);
        } else {
            if (checkbox.checked) {
                checkbox.checked = false;
                toggleSetCompleted(checkbox);
            }
        }
    }

    function toggleSetCompleted(checkbox) { 
        checkbox.closest('.set-row').classList.toggle('completed', checkbox.checked); 
    }
    
    function getProcessedBalanceData() {
        const history = getHistory();
        const muscleVolume = {};
        
        const allMuscleGroups = [...new Set(Object.values(workouts).flat().map(ex => ex.targetMuscle))].filter(m => m);
        allMuscleGroups.forEach(muscle => muscleVolume[muscle] = 0);

        history.forEach(w => {
            w.exercises.forEach(ex => {
                const exInfo = getExerciseInfo(ex.name);
                if (exInfo) {
                    const muscle = exInfo.targetMuscle;
                    if (muscle) {
                        const volume = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                        muscleVolume[muscle] = (muscleVolume[muscle] || 0) + volume;
                    }
                }
            });
        });
        
        const muscleLabels = Object.keys(muscleVolume).filter(m => muscleVolume[m] > 0);
        const volumeData = muscleLabels.map(m => muscleVolume[m]);
        
        const muscleColors = muscleLabels.map(muscle => {
            const cssVar = MUSCLE_CSS_VAR_MAP[muscle];
            return cssVar ? getCssVariable(cssVar) : '#ccc';
        });

        const sortedData = muscleLabels.map((label, index) => ({
            label,
            volume: volumeData[index],
            color: muscleColors[index]
        })).sort((a, b) => b.volume - a.volume);
        
        return {
            labels: sortedData.map(d => d.label),
            data: sortedData.map(d => d.volume),
            colors: sortedData.map(d => d.color)
        };
    }
    
    function renderBalanceChart() {
        const { labels, data, colors } = getProcessedBalanceData();
        const chartCanvas = document.getElementById('balanceChart');

        if (balanceChart) balanceChart.destroy();
        
        const chartContainer = document.querySelector('#balance-view');
        let noDataMsg = document.getElementById('balance-no-data-msg');

        if (labels.length === 0) {
            chartCanvas.style.display = 'none';
            if (!noDataMsg) {
                 noDataMsg = document.createElement('p');
                 noDataMsg.id = 'balance-no-data-msg';
                 noDataMsg.style.cssText = 'text-align:center; color: var(--text-color); margin-top: 15px;';
                 noDataMsg.textContent = 'N√£o h√° dados de volume registrados para calcular o balan√ßo muscular.';
                 chartContainer.appendChild(noDataMsg);
            }
            return;
        }

        if (noDataMsg) noDataMsg.remove();
        chartCanvas.style.display = 'block';

        updateBaseChartOptions();
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');
        
        const ctx = chartCanvas.getContext('2d');
        
        const balanceOptions = JSON.parse(JSON.stringify(BASE_CHART_OPTIONS));
        balanceOptions.plugins.legend.display = false; 
        
        balanceOptions.scales = {
            x: {
                ...balanceOptions.scales.x,
                ticks: { 
                    color: textColor,
                    font: { size: 12 },
                    maxRotation: 45,
                    minRotation: 45 
                },
                grid: { 
                    drawOnChartArea: false, 
                    borderColor: getCssVariable('--border-color')
                }
            },
            y: { 
                type: 'linear', 
                display: true, 
                position: 'left', 
                ticks: { 
                    color: textColor 
                }, 
                beginAtZero: true, 
                title: { 
                    display: true, 
                    text: 'Volume Total (Kg)', 
                    color: getCssVariable('--accent-color')
                },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            }
        };
        
        const datasets = [{
            label: 'Volume Total (Kg)',
            data: data,
            backgroundColor: colors.map(c => c + 'AA'), 
            borderColor: colors,
            borderWidth: 2,
            borderRadius: 5, 
            hoverBackgroundColor: colors,
            minBarLength: 2 
        }];

        balanceChart = new Chart(ctx, {
            type: 'bar', 
            data: { labels, datasets },
            options: balanceOptions
        });
    }

    // Fun√ß√£o para obter a Semana do Ano
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `${d.getUTCFullYear()}-W${weekNo}`;
    }

    // Fun√ß√£o para obter os dados de volume semanal
    function getWeeklyVolumeData() {
        const history = getHistory();
        const selPeriod = document.getElementById('periodSelectorWeekly').value;
        const allMuscleGroups = [...new Set(Object.values(workouts).flat().map(ex => ex.targetMuscle))].filter(m => m);
        
        const cutoff = new Date();
        if (selPeriod !== 'all') {
            cutoff.setDate(cutoff.getDate() - parseInt(selPeriod));
        } else {
            cutoff.setFullYear(cutoff.getFullYear() - 100);
        }

        const weeklyVolume = {}; // { '2025-W42': { Peito: 5000, Costas: 8000, ... } }

        history.filter(w => w.date >= cutoff).forEach(w => {
            const weekKey = getWeekNumber(w.date);
            
            if (!weeklyVolume[weekKey]) {
                weeklyVolume[weekKey] = {};
                allMuscleGroups.forEach(m => weeklyVolume[weekKey][m] = 0);
            }

            w.exercises.forEach(ex => {
                const exInfo = getExerciseInfo(ex.name);
                if (exInfo) {
                    const muscle = exInfo.targetMuscle;
                    if (muscle) {
                        const volume = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                        weeklyVolume[weekKey][muscle] += volume;
                    }
                }
            });
        });

        const sortedWeeks = Object.keys(weeklyVolume).sort();
        const labels = sortedWeeks.map(key => key.split('-W')[1]); // Exibe apenas o n√∫mero da semana

        const datasets = allMuscleGroups.map(muscle => {
            const cssVar = MUSCLE_CSS_VAR_MAP[muscle];
            const color = cssVar ? getCssVariable(cssVar) : '#ccc';
            
            const data = sortedWeeks.map(weekKey => weeklyVolume[weekKey][muscle]);

            return {
                label: muscle,
                data: data,
                borderColor: color,
                backgroundColor: color + '33', // 20% de opacidade para a √°rea
                fill: true,
                tension: 0.4,
                hidden: false, // Come√ßa vis√≠vel
                pointRadius: 3 
            };
        });
        
        return { labels, datasets };
    }
    
    // Fun√ß√£o para renderizar o gr√°fico de Volume Semanal
    function renderWeeklyVolumeChart() {
        const { labels, datasets } = getWeeklyVolumeData();
        const chartCanvas = document.getElementById('weeklyVolumeChart');
        
        const container = document.getElementById('weekly-volume-container');
        let noDataMsg = document.getElementById('weekly-volume-no-data');
        
        if (weeklyVolumeChart) weeklyVolumeChart.destroy();
        
        if (labels.length === 0) {
            chartCanvas.style.display = 'none';
            if (!noDataMsg) {
                noDataMsg = document.createElement('p');
                noDataMsg.id = 'weekly-volume-no-data';
                noDataMsg.style.cssText = 'text-align:center; color: var(--text-color); margin-top: 15px;';
                noDataMsg.textContent = 'N√£o h√° dados suficientes para calcular o volume semanal no per√≠odo selecionado.';
                container.appendChild(noDataMsg);
            }
            return;
        }

        if (noDataMsg) noDataMsg.remove();
        chartCanvas.style.display = 'block';

        updateBaseChartOptions();
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');
        
        const chartOptions = JSON.parse(JSON.stringify(BASE_CHART_OPTIONS));
        chartOptions.plugins.legend.display = true;
        
        chartOptions.scales = {
            x: {
                ...chartOptions.scales.x,
                title: { 
                    display: true, 
                    text: 'N√∫mero da Semana', 
                    color: getCssVariable('--accent-color') 
                },
                ticks: { 
                    color: textColor 
                },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            },
            y: { 
                type: 'linear', 
                display: true, 
                position: 'left', 
                ticks: { 
                    color: textColor 
                }, 
                beginAtZero: true, 
                title: { 
                    display: true, 
                    text: 'Volume Semanal (Kg)', 
                    color: getCssVariable('--volume-line-color')
                },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            }
        };

        const ctx = chartCanvas.getContext('2d');
        weeklyVolumeChart = new Chart(ctx, {
            type: 'line', 
            data: { labels, datasets },
            options: chartOptions
        });
    }

    function toggleEvolutionView(view) {
        currentEvolutionView = view;
        
        document.querySelectorAll('.evolution-mode-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`.evolution-mode-button[data-view="${view}"]`).classList.add('active');

        const individualView = document.getElementById('individual-evolution-controls');
        const weeklyView = document.getElementById('weekly-volume-container');
        const evolutionChartCanvas = document.getElementById('evolutionChart');
        const weeklyVolumeChartCanvas = document.getElementById('weeklyVolumeChart');
        const title = document.getElementById('evolution-title');

        if (view === 'individual') {
            individualView.style.display = 'block';
            weeklyView.style.display = 'none';
            evolutionChartCanvas.style.display = 'block';
            weeklyVolumeChartCanvas.style.display = 'none';
            title.textContent = 'Evolu√ß√£o Individual (Volume e Carga)';
            renderEvolutionChart();
        } else {
            individualView.style.display = 'none';
            weeklyView.style.display = 'block';
            evolutionChartCanvas.style.display = 'none';
            weeklyVolumeChartCanvas.style.display = 'block';
            title.textContent = 'An√°lise de Volume Semanal (MV)';
            renderWeeklyVolumeChart();
        }
    }

    function getProcessedChartData() {
        const history = getHistory();
        const selPeriod = document.getElementById('periodSelector').value;
        const isMuscleMode = currentEvolutionMode === 'muscle';
        const selValue = isMuscleMode 
            ? document.getElementById('muscleGroupSelector').value 
            : document.getElementById('exerciseSelector').value;

        if (!selValue || history.length === 0) return { labels: [], volData: [], weightData: [], selValue };

        const cutoff = new Date();
        if (selPeriod !== 'all') {
            cutoff.setDate(cutoff.getDate() - parseInt(selPeriod));
        } else {
            cutoff.setFullYear(cutoff.getFullYear() - 100);
        }

        const filteredHistory = history.filter(w => w.date >= cutoff);
        
        if (filteredHistory.length === 0) return { labels: [], volData: [], weightData: [], selValue };

        const dailyData = {};

        filteredHistory.forEach(w => {
            const dateStr = w.date.toLocaleDateString('pt-BR');
            
            if (!dailyData[dateStr]) {
                dailyData[dateStr] = { totalVolume: 0, maxWeights: [] };
            }

            w.exercises.forEach(ex => {
                const exInfo = getExerciseInfo(ex.name);
                const isRelevant = isMuscleMode 
                    ? (exInfo && exInfo.targetMuscle === selValue) 
                    : (ex.name === selValue);
                
                if (isRelevant) {
                    const volume = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                    const maxW = Math.max(0, ...ex.sets.map(set => set.weight));
                    
                    dailyData[dateStr].totalVolume += volume; 
                    if (maxW > 0) dailyData[dateStr].maxWeights.push(maxW); 
                }
            });
        });

        const sortedDates = Object.keys(dailyData).filter(date => dailyData[date].totalVolume > 0).sort((a, b) => {
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            };
            return parseDate(a) - parseDate(b);
        });
        
        const labels = sortedDates;
        const volData = sortedDates.map(date => dailyData[date].totalVolume);
        const weightData = sortedDates.map(date => Math.max(0, ...dailyData[date].maxWeights)); 
        
        return { labels, volData, weightData, selValue };
    }

    function renderEvolutionChart() {
        if (currentEvolutionView === 'weekly') return; // Nao renderiza se estiver no modo semanal
        
        const { labels, volData, weightData, selValue } = getProcessedChartData();
        const chartType = document.getElementById('chartTypeSelector').value;
        const isMuscleMode = currentEvolutionMode === 'muscle';
        
        const chartContainer = document.getElementById('individual-evolution-controls').parentNode; // Cont√™iner pai
        
        if (evolutionChart) evolutionChart.destroy();
        
        let chartCanvas = document.getElementById('evolutionChart');
        if (!chartCanvas || chartCanvas.tagName !== 'CANVAS') {
            const oldElement = chartCanvas;
            chartCanvas = document.createElement('canvas');
            chartCanvas.id = 'evolutionChart';
            if (oldElement) oldElement.replaceWith(chartCanvas);
            else {
                chartContainer.appendChild(chartCanvas);
            }
        }
        
        if (labels.length === 0) {
            chartCanvas.style.display = 'none';
            if (!document.getElementById('no-data-msg')) {
                 const msg = document.createElement('p');
                 msg.id = 'no-data-msg';
                 msg.style.cssText = 'text-align:center; color: var(--text-color); margin-top: 15px;';
                 msg.textContent = 'N√£o h√° dados neste per√≠odo para a sele√ß√£o. Tente mudar o exerc√≠cio/m√∫sculo ou o per√≠odo.';
                 chartContainer.appendChild(msg);
            }
            return;
        }

        const noDataMsg = document.getElementById('no-data-msg');
        if (noDataMsg) noDataMsg.remove();
        chartCanvas.style.display = 'block';

        const ctx = chartCanvas.getContext('2d');
        
        updateBaseChartOptions();

        let volumeColor;
        if (isMuscleMode) {
            const cssVar = MUSCLE_CSS_VAR_MAP[selValue];
            volumeColor = cssVar ? getCssVariable(cssVar) : getCssVariable('--accent-color');
        } else {
            volumeColor = getCssVariable('--accent-color');
        }
        
        const VOLUME_COLOR = volumeColor;
        const WEIGHT_COLOR = getCssVariable('--pr-color');
        const textColor = getCssVariable('--text-color');
        const gridColor = getCssVariable('--chart-grid-color');
        
        const chartOptions = JSON.parse(JSON.stringify(BASE_CHART_OPTIONS));
        
        chartOptions.scales = {
            x: {
                ...chartOptions.scales.x,
                ticks: { color: textColor },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            },
            yVolume: { 
                type: 'linear', 
                display: true, 
                position: 'left', 
                ticks: { color: VOLUME_COLOR }, 
                beginAtZero: true, 
                title: { 
                    display: true, 
                    text: 'Volume Total (Kg)', 
                    color: VOLUME_COLOR
                },
                grid: { 
                    color: gridColor,
                    borderColor: getCssVariable('--border-color')
                }
            },
            yWeight: { 
                type: 'linear', 
                display: true, 
                position: 'right', 
                ticks: { color: WEIGHT_COLOR }, 
                beginAtZero: true, 
                title: { 
                    display: true, 
                    text: 'Carga M√°xima (Kg)', 
                    color: WEIGHT_COLOR
                }, 
                grid: { 
                    drawOnChartArea: false 
                } 
            }
        };
        
        const datasets = [
            { 
                label: `Volume Total (Kg)`, 
                data: volData, 
                borderColor: VOLUME_COLOR, 
                backgroundColor: chartType === 'bar' ? VOLUME_COLOR.replace(')', ', 0.7)') : 'transparent', 
                yAxisID: 'yVolume',
                tension: 0.3, 
                pointRadius: chartType === 'line' ? 4 : 0 
            },
            { 
                label: `Carga M√°xima (Kg)`, 
                data: weightData, 
                borderColor: WEIGHT_COLOR, 
                backgroundColor: chartType === 'bar' ? WEIGHT_COLOR.replace(')', ', 0.7)') : 'transparent',
                yAxisID: 'yWeight',
                tension: 0.3,
                pointRadius: chartType === 'line' ? 4 : 0 
            }
        ];

        evolutionChart = new Chart(ctx, {
            type: chartType, 
            data: { labels, datasets },
            options: chartOptions
        });
    }

    function updateEvolutionModeButtons(mode) {
        currentEvolutionMode = mode;
        
        document.querySelectorAll('#individual-evolution-controls .chart-mode-button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`#individual-evolution-controls .chart-mode-button[data-mode="${mode}"]`).classList.add('active');
        
        document.getElementById('exercise-selectors').style.display = mode === 'exercise' ? 'flex' : 'none';
        document.getElementById('muscle-selectors').style.display = mode === 'muscle' ? 'flex' : 'none';
        
        renderEvolutionChart(); 
    }

    function renderEvolutionSelectors() {
        const allExercises = [...new Set(Object.values(workouts).flat().map(ex => ex.name))].sort();
        const exerciseSelector = document.getElementById('exerciseSelector');
        exerciseSelector.innerHTML = allExercises.map(name => `<option value="${name}">${name}</option>`).join('');
        
        const allMuscleGroups = [...new Set(Object.values(workouts).flat().map(ex => ex.targetMuscle))].filter(m => m).sort();
        const muscleGroupSelector = document.getElementById('muscleGroupSelector');
        muscleGroupSelector.innerHTML = allMuscleGroups.map(muscle => `<option value="${muscle}">${muscle}</option>`).join('');

        if (!exerciseSelector.onchange) {
            const renderFn = () => {
                 if (currentEvolutionView === 'individual') renderEvolutionChart();
                 else renderWeeklyVolumeChart();
            };

            exerciseSelector.onchange = renderFn;
            document.getElementById('periodSelector').onchange = renderFn;
            document.getElementById('chartTypeSelector').onchange = renderFn;
            muscleGroupSelector.onchange = renderFn;
        }
        
        toggleEvolutionView(currentEvolutionView);
        updateEvolutionModeButtons(currentEvolutionMode);
    }
    
    // Fun√ß√µes de renderiza√ß√£o de treinos e modal
    function renderWorkouts() {
        const history = getHistory();
        for (const workoutId in workouts) {
            const container = document.getElementById(`workout-${workoutId}`);
            if (!container) continue;

            const workoutSessionCount = history.filter(w => w.workoutId === workoutId).length;
            let variationNoticeHTML = '';
            if (workoutSessionCount >= VARIATION_THRESHOLD) {
                variationNoticeHTML = `<div class="variation-notice">üß† **Hora de Variar?** Voc√™ j√° fez este treino ${workoutSessionCount} vezes. Considere trocar alguns exerc√≠cios para continuar progredindo.</div>`;
            }

            const time = calculateWorkoutTime(workouts[workoutId]);
            let html = `${variationNoticeHTML}<div class="workout-header"><h2>${WORKOUT_NAMES[workoutId] || workoutId}</h2><p class="workout-meta">‚è±Ô∏è Tempo Estimado: ~${time} minutos</p><button class="secondary-button" onclick="fillFromLastWorkout('${workoutId}')">Preencher com √öltimo Treino</button></div>`;
            workouts[workoutId].forEach(ex => { html += createExerciseHTML(ex); });

            html += `<div class="notes-section"><label for="notes-${workoutId}"><h3>Notas do Treino</h3></label><textarea id="notes-${workoutId}" placeholder="Como se sentiu hoje? Alguma dor? O treino rendeu?"></textarea></div>`;
            html += `<button class="finish-button" onclick="saveWorkout('${workoutId}')">Finalizar e Salvar Treino</button>`;
            container.innerHTML = html;
        }
        
        // Estrutura do Modal
        document.getElementById('chartModal').innerHTML = `<div class="modal-content">
            <span class="close-button" onclick="closeChartModal()">&times;</span>
            <div class="modal-tabs">
                <button class="modal-tab-button active" onclick="showModalView('evolution')">Evolu√ß√£o</button>
                <button class="modal-tab-button" onclick="showModalView('balance')">Balan√ßo</button>
                <button class="modal-tab-button" onclick="showModalView('consistency')">Consist√™ncia</button>
                <button class="modal-tab-button" onclick="showModalView('records')">Recordes</button>
                <button class="modal-tab-button" onclick="showModalView('history')">Hist√≥rico</button>
            </div>
            
            <div id="evolution-view" class="modal-view active">
                <h3 id="evolution-title" style="text-align:center;">Evolu√ß√£o</h3>
                
                <div id="evolutionModeSelector">
                    <button class="evolution-mode-button active" data-view="individual" onclick="toggleEvolutionView('individual')">Individual</button>
                    <button class="evolution-mode-button" data-view="weekly" onclick="toggleEvolutionView('weekly')">Volume Semanal (MV)</button>
                </div>

                <div id="individual-evolution-controls">
                    <div class="chart-mode-selector">
                        <button class="chart-mode-button active" data-mode="exercise" onclick="updateEvolutionModeButtons('exercise')">Por Exerc√≠cio</button>
                        <button class="chart-mode-button" data-mode="muscle" onclick="updateEvolutionModeButtons('muscle')">Por M√∫sculo</button>
                    </div>

                    <div class="chart-controls">
                        <div id="exercise-selectors" class="chart-select-group">
                            <select id="exerciseSelector"></select>
                        </div>
                        <div id="muscle-selectors" class="chart-select-group" style="display: none;">
                            <select id="muscleGroupSelector"></select>
                        </div>

                        <div class="chart-select-group">
                            <select id="periodSelector">
                                <option value="30">1 M√™s</option>
                                <option value="90">3 Meses</option>
                                <option value="180">6 Meses</option>
                                <option value="365">1 Ano</option>
                                <option value="all">Todo Per√≠odo</option>
                            </select>
                            <select id="chartTypeSelector">
                                <option value="line">Linhas</option>
                                <option value="bar">Barras</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="weekly-volume-container" style="display: none;">
                    <div class="chart-controls" style="display: block;">
                         <label for="periodSelectorWeekly" style="font-weight: bold; margin-right: 1rem;">Per√≠odo:</label>
                         <select id="periodSelectorWeekly" onchange="renderWeeklyVolumeChart()">
                            <option value="60">√öltimas 8 Semanas</option>
                            <option value="90">√öltimas 12 Semanas</option>
                            <option value="180">√öltimos 6 Meses</option>
                            <option value="all">Todo Per√≠odo</option>
                         </select>
                    </div>
                    <canvas id="weeklyVolumeChart" style="max-height: 350px; width: 100%;"></canvas>
                </div>
                
                <canvas id="evolutionChart"></canvas>
            </div>
            
            <div id="balance-view" class="modal-view">
                <h3 style="text-align:center;">Balan√ßo Muscular (Volume Total)</h3>
                <canvas id="balanceChart"></canvas>
            </div>
            <div id="consistency-view" class="modal-view">
                <h3 style="text-align:center;">Frequ√™ncia de Treinos</h3>
                <div id="calendar-header-controls" style="display:flex; justify-content: space-between; align-items:center; margin-bottom: 1rem;">
                    <button class="secondary-button" onclick="changeCalendarMonth(-1)">&#9664; Anterior</button>
                    <h4 id="current-month-display" style="margin: 0;">M√™s/Ano</h4>
                    <button class="secondary-button" onclick="changeCalendarMonth(1)">Pr√≥ximo &#9654;</button>
                </div>
                <div id="consistency-calendar"></div>
            </div>
            <div id="records-view" class="modal-view">
                <h3 style="text-align:center;">Gr√°ficos de Recordes Pessoais (PRs e E1RM)</h3>
                
                <div class="chart-mode-selector" style="margin-bottom: 2rem;">
                    <button class="chart-record-button active" data-mode="weight" onclick="toggleRecordsChartMode('weight')">PR - Peso M√°ximo</button>
                    <button class="chart-record-button" data-mode="e1rm" onclick="toggleRecordsChartMode('e1rm')">PR - E1RM M√°ximo</button>
                </div>

                <h4 style="text-align:center; color: var(--calendar-upper-color);">Recordes de Superiores (Top 10)</h4>
                <div style="margin-bottom: 0.5rem; text-align: center;">
                    <canvas id="recordsUpperChart" style="max-height: 350px; width: 100%;"></canvas>
                </div>

                <h4 style="text-align:center; color: var(--calendar-lower-color);">Recordes de Inferiores (Top 10)</h4>
                <div style="margin-bottom: 1.5rem; text-align: center;">
                    <canvas id="recordsLowerChart" style="max-height: 350px; width: 100%;"></canvas>
                </div>
                
                <h4 style="text-align:center; color: var(--progress-color); border-top: 1px solid var(--border-color); padding-top: 1rem; margin-top: 1rem;">üí™ Maiores Progressos de E1RM (√öltimos 60 dias)</h4>
                <div style="margin-bottom: 1.5rem; text-align: center;">
                    <canvas id="progressorsChart" style="max-height: 350px; width: 100%;"></canvas>
                </div>

                <div id="pr-manager"></div>
            </div>
            <div id="history-view" class="modal-view">
                <div class="history-manager-header">
                    <h3>Hist√≥rico Completo</h3>
                    <div style="display: flex; gap: 10px;">
                        <button class="data-io-button export-button" onclick="exportHistory()">Exportar</button>
                        <button class="data-io-button import-button" onclick="document.getElementById('import-file-input').click()">Importar</button>
                    </div>
                </div>
                <div id="history-manager"></div>
            </div>
        </div>`;
        
        renderEvolutionSelectors(); 
    } 
    
    function renderHistory() {
        const historyManager = document.getElementById('history-manager');
        const history = getHistory().reverse(); 
        historyManager.innerHTML = '';

        if (history.length === 0) {
            historyManager.innerHTML = `<p style="text-align:center; color: var(--text-color); margin-top: 15px;">Nenhum treino registrado no hist√≥rico.</p>`;
            return;
        }

        let html = '';
        history.forEach((w, index) => {
            const workoutName = WORKOUT_NAMES[w.workoutId] || w.workoutId;
            const totalVolume = w.exercises.reduce((sum, ex) => 
                sum + ex.sets.reduce((exSum, set) => exSum + (set.weight * set.reps), 0), 0);
            
            const originalIndex = getHistory().length - 1 - index; 

            html += `
                <div class="history-item">
                    <div class="history-item-info">
                        <strong>${workoutName}</strong> - ${new Date(w.date).toLocaleDateString('pt-BR')}
                        <div class="history-item-details">
                            Volume Total: ${totalVolume.toFixed(2)} kg
                        </div>
                        ${w.notes ? `<div class="history-item-notes">Notas: ${w.notes}</div>` : ''}
                    </div>
                    <button class="delete-btn" onclick="deleteHistoryItem(${originalIndex})">üóëÔ∏è</button>
                </div>
            `;
        });

        historyManager.innerHTML = html;
    }

    function deleteHistoryItem(originalIndex) {
        if (confirm("Tem certeza que deseja deletar este treino do hist√≥rico? Esta a√ß√£o √© irrevers√≠vel.")) {
            const history = getHistory(); 
            history.splice(originalIndex, 1); 
            
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            
            showToast('Treino removido do hist√≥rico.', 'success');
            renderHistory(); 
            renderWorkouts(); 
        }
    }
    
    function fillFromLastWorkout(workoutId) { 
        const history = getHistory(); 
        const lastWorkout = history.slice().reverse().find(w => w.workoutId === workoutId); 
        if (!lastWorkout) { 
            showToast(`Nenhum treino anterior do tipo "${WORKOUT_NAMES[workoutId] || workoutId}" foi encontrado.`, 'warning'); 
            return; 
        } 
        const workoutContainer = document.getElementById(`workout-${workoutId}`); 
        lastWorkout.exercises.forEach(ex => { 
            const card = workoutContainer.querySelector(`.exercise-card[data-exercise-name="${ex.name}"]`); 
            if (card) { 
                const rows = card.querySelectorAll('.set-row'); 
                ex.sets.forEach((set, index) => { 
                    const row = rows[index]; 
                    if (row) { 
                        row.querySelector('.weight-input').value = set.weight; 
                        row.querySelector('.reps-input').value = set.reps; 
                        
                        const rpeInput = row.querySelector('.rpe-input');
                        if (rpeInput && set.rpe) {
                            rpeInput.value = set.rpe;
                            checkRpeRange(rpeInput);
                        }
                        
                        const checkbox = row.querySelector('.set-checkbox'); 
                        checkbox.checked = true; 
                        toggleSetCompleted(checkbox); 
                    } 
                }); 
            } 
        }); 
        showToast('Pesos, repeti√ß√µes e RPE preenchidos com base no √∫ltimo treino.', 'success'); 
    } 

    function showWorkout(id) { 
        document.querySelectorAll('.workout-plan').forEach(p => p.classList.remove('active')); 
        document.getElementById(`workout-${id}`).classList.add('active'); 
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active')); 
        document.querySelector(`.tab-button[onclick="showWorkout('${id}')"]`).classList.add('active'); 
    } 
    
    let timerInterval; 
    const notificationSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('12121212')); 
    
    function startTimer(button, duration) { 
        if (button.classList.contains('timing')) return; 
        button.classList.add('timing'); 
        let timeLeft = duration; 
        const originalText = 'Iniciar Descanso'; 
        
        clearInterval(timerInterval); 
        
        timerInterval = setInterval(() => { 
            timeLeft--; 
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60; 
            button.textContent = `Descansando... ${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`; 
            
            if (timeLeft <= 0) { 
                clearInterval(timerInterval); 
                button.classList.remove('timing'); 
                button.textContent = originalText; 
                notificationSound.play(); 
                if (navigator.vibrate) navigator.vibrate(200); 
                showToast('Descanso finalizado! Pr√≥xima s√©rie.', 'info', 5000); 
            } 
        }, 1000); 
    } 

    function saveWorkout(workoutId) { 
        const notes = document.getElementById(`notes-${workoutId}`).value; 
        const workoutData = { 
            date: new Date().toISOString(), 
            workoutId: workoutId, 
            exercises: [], 
            notes: notes 
        }; 
        const container = document.getElementById(`workout-${workoutId}`); 
        let newPrs = []; 
        let hasInvalidRpe = false;
        
        container.querySelectorAll('.exercise-card').forEach(card => { 
            const name = card.dataset.exerciseName; 
            const sets = []; 
            let maxWeightInWorkout = 0; 
            
            card.querySelectorAll('.set-row').forEach(row => { 
                const isChecked = row.querySelector('.set-checkbox').checked; 
                const weightInput = row.querySelector('.weight-input').value; 
                const repsInput = row.querySelector('.reps-input').value; 
                const rpeInput = row.querySelector('.rpe-input').value; 
                
                if (isChecked && weightInput && repsInput) { 
                    const w = parseFloat(weightInput); 
                    const r = parseInt(repsInput); 
                    const rpe = parseFloat(rpeInput) || null; 
                    
                    if(rpe && (rpe < 6 || rpe > 10)) {
                         hasInvalidRpe = true;
                    }

                    sets.push({ weight: w, reps: r, rpe: rpe }); 
                    if (w > maxWeightInWorkout) maxWeightInWorkout = w; 
                }
            }); 
            
            if (sets.length > 0) { 
                workoutData.exercises.push({ name: name, sets: sets }); 
                const oldPr = getPersonalRecord(name); 
                if (maxWeightInWorkout > oldPr) newPrs.push({ name: name, weight: maxWeightInWorkout }); 
            } 
        }); 
        
        if (workoutData.exercises.length === 0) { 
            showToast("Nenhum dado para salvar. Preencha pelo menos uma s√©rie.", 'warning'); 
            return;
        } 
        
        if (hasInvalidRpe) {
             showToast("Aten√ß√£o: Um ou mais RPEs est√£o fora do intervalo (6 a 10). Verifique antes de salvar.", 'warning');
             return;
        }
        
        let history = getHistory(); 
        history.push(workoutData); 
        localStorage.setItem('workoutHistory', JSON.stringify(history)); 
        
        let alertMessage = `Treino salvo com sucesso!`; 
        if (newPrs.length > 0) { 
            newPrs.forEach(pr => { 
                showToast(`üèÜ NOVO PR! ${pr.name}: ${pr.weight}kg. Parab√©ns!`, 'pr', 8000); 
            }); 
        } 
        showToast(alertMessage, 'success'); 
        renderWorkouts(); 
        showWorkout(workoutId); 
    } 
    
    const chartModal = document.getElementById('chartModal');

    function openChartModal() {
        chartModal.classList.add('show');
        showModalView('evolution'); 
    }

    function closeChartModal() {
        chartModal.classList.remove('show');
    }

    function showModalView(viewId) {
        document.querySelectorAll('.modal-view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewId}-view`).classList.add('active');
        document.querySelectorAll('.modal-tab-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.modal-tab-button[onclick="showModalView('${viewId}')"]`).classList.add('active');
        
        if (viewId === 'evolution') {
            // Garante que o modo de visualiza√ß√£o correto seja renderizado
            toggleEvolutionView(currentEvolutionView); 
        }
        if (viewId === 'balance') renderBalanceChart(); 
        if (viewId === 'consistency') renderConsistencyCalendar();
        if (viewId === 'records') {
            renderPRs(); 
            renderRecordsChart('upper'); 
            renderRecordsChart('lower');
            renderProgressorsChart(); 
        }
        if (viewId === 'history') renderHistory();
    }
    
    function exportHistory() {
    const history = localStorage.getItem('workoutHistory');
    if (!history) { showToast("Nenhum dado de hist√≥rico para exportar.", 'warning'); return; }

    try {
        // Parse o JSON e formata com indenta√ß√£o
        const parsedHistory = JSON.parse(history);
        const formattedHistory = JSON.stringify(parsedHistory, null, 2); // 2 espa√ßos de indenta√ß√£o
        
        const blob = new Blob([formattedHistory], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `BKP_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Hist√≥rico exportado com sucesso!', 'success');
    } catch (error) {
        showToast('Erro ao formatar dados para exporta√ß√£o.', 'error');
        console.error('Export error:', error);
    }
}
    
    document.getElementById('import-file-input').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedHistory = JSON.parse(e.target.result);
                if (Array.isArray(importedHistory) && importedHistory.every(item => item.date && item.workoutId)) {
                    localStorage.setItem('workoutHistory', JSON.stringify(importedHistory));
                    showToast(`${importedHistory.length} registros importados com sucesso (substituindo os atuais)!`, 'success');
                } else {
                     showToast('O arquivo importado n√£o parece ser um hist√≥rico v√°lido.', 'error');
                }
            } catch (error) {
                showToast('Erro ao importar o arquivo. Verifique se o arquivo √© um JSON v√°lido exportado por este aplicativo.', 'error');
            }
            location.reload(); 
        };
        reader.readAsText(file);
        event.target.value = '';
    });
    
    function checkForDeloadSuggestion() {
        const history = getHistory();
        if (history.length < 20) return;

        const firstWorkoutDate = history[0].date; 
        const today = new Date();
        const daysSinceFirstWorkout = (today - firstWorkoutDate) / (1000 * 60 * 60 * 24); 
        
        if (daysSinceFirstWorkout > 56 || history.length % 20 === 0) {
            const deloadContainer = document.getElementById('deload-notice-container');
            if (!deloadContainer.querySelector('.deload-notice')) {
                const deloadNotice = document.createElement('div');
                deloadNotice.className = 'deload-notice';
                deloadNotice.innerHTML = '‚ö†Ô∏è **SUGEST√ÉO DE DELOAD:** Voc√™ tem treinado intensamente por um tempo. Considere fazer uma semana de deload para recupera√ß√£o! Clique para remover.';
                deloadNotice.onclick = () => deloadNotice.remove();
                deloadContainer.appendChild(deloadNotice);
            }
        }
    }

    // Fun√ß√£o para verificar e mostrar recomenda√ß√µes de progress√£o
    function checkForProgressionRecommendations() {
        const analysis = analyzeProgression();
        if (!analysis) return;
        
        if (analysis.stagnating.length > 2) {
            const progressionContainer = document.getElementById('progression-notice-container');
            if (!progressionContainer.querySelector('.progression-notice')) {
                const progressionNotice = document.createElement('div');
                progressionNotice.className = 'progression-notice';
                progressionNotice.innerHTML = 'üí° **AN√ÅLISE DE PROGRESS√ÉO:** V√°rios exerc√≠cios est√£o estagnados. Clique para ver recomenda√ß√µes.';
                progressionNotice.onclick = showProgressionAnalysis;
                progressionContainer.appendChild(progressionNotice);
            }
        }
    }

    // SISTEMA DE ALERTA INTELIGENTE
    function analyzeSmartAlerts() {
        const history = getHistory();
        if (history.length < 5) return [];
        
        const alerts = [];
        const today = new Date();
        
        // 1. Verificar frequ√™ncia de treino
        const lastWorkoutDate = new Date(history[history.length - 1].date);
        const daysSinceLastWorkout = Math.floor((today - lastWorkoutDate) / (1000 * 60 * 60 * 24));
        
        if (daysSinceLastWorkout > 7) {
            alerts.push({
                type: 'frequency',
                priority: 'high',
                title: 'Frequ√™ncia de Treino Baixa',
                message: `Faz ${daysSinceLastWorkout} dias desde seu √∫ltimo treino. Consist√™ncia √© fundamental para resultados!`,
                recommendation: 'Programe seu pr√≥ximo treino o quanto antes.'
            });
        }
        
        // 2. Verificar desequil√≠brio muscular
        const balanceData = getProcessedBalanceData();
        if (balanceData.labels.length > 0) {
            const maxVolume = Math.max(...balanceData.data);
            const minVolume = Math.min(...balanceData.data);
            const imbalanceRatio = maxVolume / minVolume;
            
            if (imbalanceRatio > 3) {
                const weakestMuscle = balanceData.labels[balanceData.data.indexOf(minVolume)];
                alerts.push({
                    type: 'balance',
                    priority: 'medium',
                    title: 'Desequil√≠brio Muscular Detectado',
                    message: `Seu volume de treino para ${weakestMuscle} est√° significativamente menor que outros grupos musculares.`,
                    recommendation: `Considere aumentar o volume ou frequ√™ncia para ${weakestMuscle}.`
                });
            }
        }
        
        // 3. Verificar progress√£o estagnada
        const progressionAnalysis = analyzeProgression();
        if (progressionAnalysis && progressionAnalysis.stagnating.length > 3) {
            alerts.push({
                type: 'progression',
                priority: 'medium',
                title: 'Progress√£o Estagnada',
                message: `${progressionAnalysis.stagnating.length} exerc√≠cios est√£o mostrando pouco ou nenhum progresso.`,
                recommendation: 'Considere mudar exerc√≠cios, aumentar intensidade ou variar o volume.'
            });
        }
        
        // 4. Verificar RPE consistente fora da zona ideal
        let lowRpeCount = 0;
        let highRpeCount = 0;
        
        history.slice(-10).forEach(workout => {
            workout.exercises.forEach(exercise => {
                exercise.sets.forEach(set => {
                    if (set.rpe) {
                        if (set.rpe < 7) lowRpeCount++;
                        if (set.rpe > 9) highRpeCount++;
                    }
                });
            });
        });
        
        if (lowRpeCount > highRpeCount * 2) {
            alerts.push({
                type: 'intensity',
                priority: 'low',
                title: 'Intensidade Muito Baixa',
                message: 'Muitas s√©ries est√£o sendo feitas com RPE abaixo de 7.',
                recommendation: 'Aumente a intensidade para continuar progredindo.'
            });
        }
        
        if (highRpeCount > lowRpeCount * 3) {
            alerts.push({
                type: 'intensity',
                priority: 'medium',
                title: 'Intensidade Muito Alta',
                message: 'Muitas s√©ries est√£o sendo feitas com RPE acima de 9.',
                recommendation: 'Considere reduzir a intensidade para evitar overtraining.'
            });
        }
        
        // 5. Verificar volume semanal excessivo
        const weeklyVolume = getWeeklyVolumeData();
        if (weeklyVolume.labels.length > 0) {
            const recentWeeks = weeklyVolume.datasets[0].data.slice(-4); // √öltimas 4 semanas
            const avgVolume = recentWeeks.reduce((a, b) => a + b, 0) / recentWeeks.length;
            
            if (avgVolume > 20000) { // Limite arbitr√°rio - ajustar conforme necess√°rio
                alerts.push({
                    type: 'volume',
                    priority: 'medium',
                    title: 'Volume Semanal Elevado',
                    message: 'Seu volume de treino est√° consistentemente alto.',
                    recommendation: 'Considere uma semana de deload ou redu√ß√£o de volume para otimizar recupera√ß√£o.'
                });
            }
        }
        
        return alerts;
    }
    
    // Fun√ß√£o para mostrar alertas inteligentes
    function showSmartAlerts() {
        const alerts = analyzeSmartAlerts();
        const modal = document.getElementById('smartAlertsModal');
        
        let html = `
            <div class="modal-content">
                <span class="close-button" onclick="closeSmartAlertsModal()">&times;</span>
                <h2 style="text-align:center; color: var(--alert-color);">Alertas Inteligentes</h2>
        `;
        
        if (alerts.length === 0) {
            html += `
                <div style="text-align:center; padding: 2rem;">
                    <h3 style="color: var(--success-color);">‚úÖ Tudo em Ordem!</h3>
                    <p>Nenhum alerta cr√≠tico detectado. Continue com seu programa atual.</p>
                </div>
            `;
        } else {
            // Ordenar alertas por prioridade
            const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
            alerts.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
            
            html += `<div style="margin-top: 1rem;">`;
            
            alerts.forEach(alert => {
                let priorityColor;
                switch(alert.priority) {
                    case 'high': priorityColor = 'var(--danger-color)'; break;
                    case 'medium': priorityColor = 'var(--warning-color)'; break;
                    case 'low': priorityColor = 'var(--info-color)'; break;
                }
                
                html += `
                    <div class="smart-alert" style="margin-bottom: 1rem; text-align: left; cursor: default;">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${priorityColor}; margin-right: 10px;"></div>
                            <h4 style="margin: 0;">${alert.title}</h4>
                        </div>
                        <p style="margin: 0.5rem 0;">${alert.message}</p>
                        <p style="margin: 0; font-style: italic;"><strong>Recomenda√ß√£o:</strong> ${alert.recommendation}</p>
                    </div>
                `;
            });
            
            html += `</div>`;
        }
        
        html += `</div>`;
        
        modal.innerHTML = html;
        modal.classList.add('show');
    }
    
    // Fun√ß√£o para fechar modal de alertas
    function closeSmartAlertsModal() {
        document.getElementById('smartAlertsModal').classList.remove('show');
    }
    
    // Fun√ß√£o para verificar e exibir alertas automaticamente
    function checkAndShowSmartAlerts() {
        const alerts = analyzeSmartAlerts();
        const highPriorityAlerts = alerts.filter(alert => alert.priority === 'high');
        
        if (highPriorityAlerts.length > 0) {
            const alertContainer = document.getElementById('smart-alert-container');
            
            // Limpar alertas existentes
            alertContainer.innerHTML = '';
            
            highPriorityAlerts.forEach(alert => {
                const alertElement = document.createElement('div');
                alertElement.className = 'smart-alert';
                alertElement.innerHTML = `
                    <strong>${alert.title}</strong><br>
                    ${alert.message}<br>
                    <em>${alert.recommendation}</em>
                `;
                alertElement.onclick = showSmartAlerts;
                alertContainer.appendChild(alertElement);
            });
        }
    }

    const themeSwitcher = document.getElementById('theme-switcher');
    const doc = document.documentElement;
    
    function applyTheme(theme) {
        doc.setAttribute('data-theme', theme);
        themeSwitcher.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', theme);
        
        if (document.getElementById('evolution-view') && document.getElementById('evolution-view').classList.contains('active')) {
             // S√≥ renderiza a view ativa
             toggleEvolutionView(currentEvolutionView);
        }
        if (document.getElementById('balance-view') && document.getElementById('balance-view').classList.contains('active')) {
             renderBalanceChart(); 
        }
        if (document.getElementById('records-view') && document.getElementById('records-view').classList.contains('active')) {
             renderRecordsChart('upper'); 
             renderRecordsChart('lower');
             renderProgressorsChart(); 
        }
    }

    themeSwitcher.addEventListener('click', () => {
        const currentTheme = doc.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    let currentCalendarDate = new Date();
    
    function getConsistencyData() {
        const history = getHistory();
        const consistencyMap = {}; 

        history.forEach(w => {
            const date = new Date(w.date);
            const dateKey = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            
            if (!consistencyMap[dateKey]) {
                consistencyMap[dateKey] = { upper: false, lower: false };
            }

            if (w.workoutId.startsWith('Upper')) {
                consistencyMap[dateKey].upper = true;
            } else if (w.workoutId.startsWith('Lower')) {
                consistencyMap[dateKey].lower = true;
            }
        });

        return consistencyMap;
    }

    function renderConsistencyCalendar(date = currentCalendarDate) {
        currentCalendarDate = date;
        const calendarContainer = document.getElementById('consistency-calendar');
        const monthDisplay = document.getElementById('current-month-display');
        const consistencyData = getConsistencyData();
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const startOfMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        const endOfMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0);
        
        const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const dayNames = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

        monthDisplay.textContent = `${monthNames[date.getMonth()]} de ${date.getFullYear()}`;
        calendarContainer.innerHTML = '';
        
        dayNames.forEach(day => {
            const header = document.createElement('div');
            header.className = 'calendar-header';
            header.textContent = day;
            calendarContainer.appendChild(header);
        });

        const startDayIndex = startOfMonth.getDay();
        for (let i = 0; i < startDayIndex; i++) {
            calendarContainer.appendChild(document.createElement('div'));
        }

        for (let day = 1; day <= endOfMonth.getDate(); day++) {
            const currentDate = new Date(date.getFullYear(), date.getMonth(), day);
            const dateKey = `${currentDate.getFullYear()}-${(currentDate.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';

            const daySpan = document.createElement('span');
            daySpan.textContent = day;
            dayElement.appendChild(daySpan);

            const data = consistencyData[dateKey];
            if (data) {
                dayElement.classList.add('has-data');
                
                let tooltipContent = `Dia ${day}:`;

                if (data.upper && data.lower) {
                    dayElement.classList.add('mixed');
                    tooltipContent += ' Superiores e Inferiores';
                } else if (data.upper) {
                    dayElement.classList.add('upper-only');
                    tooltipContent += ' Superiores';
                } else if (data.lower) {
                    dayElement.classList.add('lower-only');
                    tooltipContent += ' Inferiores';
                }

                dayElement.title = tooltipContent;
            } else {
                 if (currentDate > today) {
                     dayElement.style.opacity = 0.4;
                 }
            }
            
            calendarContainer.appendChild(dayElement);
        }
    }

    function changeCalendarMonth(offset) {
        const newDate = new Date(currentCalendarDate.getTime());
        newDate.setMonth(newDate.getMonth() + offset);
        renderConsistencyCalendar(newDate);
    }
    
    // --- L√ìGICA DO EDITOR DE TREINOS (NOVO) ---

    function openEditorModal() {
        document.getElementById('editorModal').classList.add('show');
        renderEditorList();
    }

    function closeEditorModal() {
        document.getElementById('editorModal').classList.remove('show');
        // Recarrega a aplica√ß√£o para refletir mudan√ßas
        renderWorkouts();
        // Se estivermos na aba ativa, recarrega ela
        const activeTab = document.querySelector('.tab-button.active');
        if(activeTab) {
            const workoutId = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
            showWorkout(workoutId);
        }
    }

    function saveWorkoutsToStorage() {
        localStorage.setItem('customWorkouts', JSON.stringify(workouts));
        showToast('Altera√ß√µes salvas!', 'success');
        renderEditorList(); // Re-renderiza a lista para atualizar √≠ndices se necess√°rio
    }

    function resetToDefaultWorkouts() {
        if(confirm("Tem certeza? Isso apagar√° todas as suas personaliza√ß√µes na rotina.")) {
            workouts = JSON.parse(JSON.stringify(DEFAULT_WORKOUTS));
            saveWorkoutsToStorage();
        }
    }

    function renderEditorList() {
        const workoutId = document.getElementById('editorWorkoutSelect').value;
        const list = document.getElementById('editorList');
        const exercises = workouts[workoutId];
        
        list.innerHTML = '';

        if(exercises.length === 0) {
            list.innerHTML = '<li style="padding:10px; text-align:center; color:#888;">Nenhum exerc√≠cio neste treino.</li>';
        }

        exercises.forEach((ex, index) => {
            const li = document.createElement('li');
            li.className = 'editor-item';
            li.innerHTML = `
                <div class="editor-item-info">
                    <span class="editor-item-title">${ex.name}</span>
                    <span class="editor-item-details">${ex.sets} x ${ex.reps} | ${ex.rest}s | ${ex.targetMuscle}</span>
                </div>
                <div class="editor-controls">
                    <button class="editor-btn btn-move" onclick="moveExercise('${workoutId}', ${index}, -1)" title="Subir">‚¨ÜÔ∏è</button>
                    <button class="editor-btn btn-move" onclick="moveExercise('${workoutId}', ${index}, 1)" title="Descer">‚¨áÔ∏è</button>
                    <button class="editor-btn btn-delete" onclick="deleteExercise('${workoutId}', ${index})" title="Remover">üóëÔ∏è</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    function addExerciseToEditor() {
        const workoutId = document.getElementById('editorWorkoutSelect').value;
        const name = document.getElementById('newExName').value.trim();
        const sets = parseInt(document.getElementById('newExSets').value);
        const reps = document.getElementById('newExReps').value.trim();
        const rest = parseInt(document.getElementById('newExRest').value);
        const muscle = document.getElementById('newExMuscle').value;

        if (!name || !sets || !reps || !rest || !muscle) {
            showToast('Preencha todos os campos!', 'warning');
            return;
        }

        workouts[workoutId].push({
            name: name,
            sets: sets,
            reps: reps,
            rest: rest,
            targetMuscle: muscle
        });

        // Limpar campos
        document.getElementById('newExName').value = '';
        document.getElementById('newExSets').value = '';
        document.getElementById('newExReps').value = '';
        document.getElementById('newExRest').value = '';
        document.getElementById('newExMuscle').value = '';

        saveWorkoutsToStorage();
    }

    function deleteExercise(workoutId, index) {
        if(confirm('Remover este exerc√≠cio?')) {
            workouts[workoutId].splice(index, 1);
            saveWorkoutsToStorage();
        }
    }

    function moveExercise(workoutId, index, direction) {
        const exercises = workouts[workoutId];
        const newIndex = index + direction;

        if (newIndex >= 0 && newIndex < exercises.length) {
            // Swap
            [exercises[index], exercises[newIndex]] = [exercises[newIndex], exercises[index]];
            saveWorkoutsToStorage();
        }
    }

    // Adicionar handler de fechamento ao modal do editor
    window.onclick = function(event) { 
        if (event.target == document.getElementById('chartModal')) closeChartModal();
        if (event.target == document.getElementById('progressionModal')) closeProgressionModal();
        if (event.target == document.getElementById('smartAlertsModal')) closeSmartAlertsModal();
        if (event.target == document.getElementById('editorModal')) closeEditorModal(); // Handler para o novo modal
    }

    // Inicializa√ß√£o da aplica√ß√£o
    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
        createFocusOverlay();
        renderWorkouts();
        checkForDeloadSuggestion();
        checkForProgressionRecommendations();
        checkAndShowSmartAlerts();
        showWorkout('UpperA');
    });
</script>
</body>
</html>
