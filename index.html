<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Treino de Hipertrofia</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #0a0a0a; --secondary-color: #1a1a1a; --text-color: #e0e0e0;
            --accent-color: #007bff; --success-color: #28a745; --danger-color: #dc3545;
            --warning-color: #ffc107; --info-color: #17a2b8; --pr-color: #f9b115;
            --input-bg: #333; --border-color: #444;
            --calendar-day-bg: #2c2c2e; 
            --calendar-upper-color: #007bff; /* Azul */
            --calendar-lower-color: #28a745; /* Verde */
            /* Cores para Target Muscle (Melhoria) */
            --muscle-chest: #dc3545; /* Vermelho */
            --muscle-shoulders: #ffc107; /* Amarelo */
            --muscle-back: #007bff; /* Azul */
            --muscle-biceps: #28a745; /* Verde */
            --muscle-triceps: #17a2b8; /* Ciano */
            --muscle-legs: #f9b115; /* Laranja */
            --muscle-glutes: #9c27b0; /* Roxo */
            --muscle-hamstrings: #8bc34a; /* Verde Claro */
            --muscle-calves: #607d8b; /* Cinza Azulado */
        }
        [data-theme="light"] {
            --primary-color: #f4f4f9; --secondary-color: #ffffff; --text-color: #0a0a0a;
            --input-bg: #e9ecef; --border-color: #dee2e6;
            --calendar-day-bg: #e9ecef;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            background-color: var(--primary-color ); color: var(--text-color); margin: 0; padding: 1rem;
            line-height: 1.6; transition: background-color 0.3s, color 0.3s;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 1rem; }
        .header-container { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-color); }
        h1 { text-align: left; color: var(--accent-color); border-bottom: none; margin: 0; padding-bottom: 0.5rem; font-size: 1.8rem; }
        h2, h3 { text-align: center; color: var(--accent-color); }
        .theme-switcher { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--text-color); padding: 0.5rem; }
        .main-controls, .workout-selector { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .tab-button, .main-button, .secondary-button {
            padding: 0.75rem 1.5rem; font-size: 1rem; font-weight: bold; cursor: pointer;
            border: 2px solid var(--accent-color); background-color: transparent; color: var(--accent-color);
            border-radius: 8px; transition: background-color 0.3s, color 0.3s;
        }
        .tab-button:hover, .tab-button.active { background-color: var(--accent-color); color: var(--primary-color); }
        .main-button { border-color: var(--success-color); color: var(--success-color); }
        .main-button:hover { background-color: var(--success-color); color: var(--primary-color); }
        .secondary-button { font-size: 0.8rem; padding: 0.5rem 1rem; border-color: #6c757d; color: #6c757d; }
        .secondary-button:hover { background-color: #6c757d; color: white; }
        .workout-header { text-align: center; }
        .workout-plan { display: none; } .workout-plan.active { display: block; }
        .workout-meta { color: #888; margin-top: -1rem; margin-bottom: 1rem; font-style: italic; }
        .variation-notice, .deload-notice {
            padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center; font-weight: bold;
            cursor: pointer;
        }
        .variation-notice { background-color: var(--warning-color); color: #1a1a1a; }
		.deload-notice { background-color: var(--info-color); color: white; }
        
        /* Melhoria: Cores de Categoria e PR */
        .exercise-card { 
            background-color: var(--secondary-color); border-radius: 10px; padding: 1.5rem; 
            margin-bottom: 1.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            transition: background-color 0.3s, border-left 0.3s;
            border-left: 5px solid var(--muscle-chest); /* Default ou Peito */
        }
        .exercise-card[data-muscle="Peito"] { border-left-color: var(--muscle-chest); }
        .exercise-card[data-muscle="Ombros"] { border-left-color: var(--muscle-shoulders); }
        .exercise-card[data-muscle="Costas"] { border-left-color: var(--muscle-back); }
        .exercise-card[data-muscle="B√≠ceps"] { border-left-color: var(--muscle-biceps); }
        .exercise-card[data-muscle="Tr√≠ceps"] { border-left-color: var(--muscle-triceps); }
        .exercise-card[data-muscle="Pernas"] { border-left-color: var(--muscle-legs); }
        .exercise-card[data-muscle="Posteriores"] { border-left-color: var(--muscle-hamstrings); }
        .exercise-card[data-muscle="Gl√∫teos"] { border-left-color: var(--muscle-glutes); }
        .exercise-card[data-muscle="Panturrilhas"] { border-left-color: var(--muscle-calves); }

        .exercise-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem; }
        .exercise-title { font-size: 1.5rem; font-weight: bold; margin: 0; }
        .exercise-meta { font-size: 0.9rem; color: #aaa; }
        .pr-badge { 
            font-size: 0.8rem; color: var(--pr-color); font-weight: bold; margin-left: 10px; 
            text-shadow: 0 0 5px rgba(249, 177, 21, 0.7); /* Efeito de brilho */
        }
        .sets-table { width: 100%; border-collapse: collapse; }
        .sets-table th, .sets-table td { padding: 0.75rem; text-align: center; border-bottom: 1px solid var(--border-color); transition: opacity 0.3s; }
        .sets-table th { font-size: 0.9rem; text-transform: uppercase; color: #bbb; }
        
        /* Melhoria: Destaque de S√©rie Completa */
        .set-row.completed td { background-color: rgba(40, 167, 69, 0.1); opacity: 0.8; }
        .set-row.completed .input-field { text-decoration: none; } /* Remove o line-through dos campos de input */
        
        .input-field { width: 50px; padding: 0.5rem; background-color: var(--input-bg); color: var(--text-color); border: 1px solid #555; border-radius: 5px; text-align: center; font-size: 1rem; }
        .input-field.weight-input { width: 70px; } /* Maior para o peso */
        .input-field.reps-input { width: 50px; } /* Menor para as reps */
        .input-field::placeholder { color: #888; font-size: 0.9em; }
        .set-checkbox { width: 22px; height: 22px; cursor: pointer; }
        .timer-button { 
            padding: 0.75rem 1rem; font-size: 1rem; font-weight: bold; cursor: pointer; border: none; 
            border-radius: 8px; background-color: var(--success-color); color: white; 
            transition: background-color 0.3s; min-width: 180px; 
            position: relative;
        }
        .timer-button.timing { background-color: var(--danger-color); cursor: not-allowed; }
        .timer-rest-info { font-size: 0.75rem; color: #ccc; margin-top: 5px; } /* Info de descanso */

        .notes-section { margin-top: 2rem; }
        .notes-section textarea { width: 100%; box-sizing: border-box; height: 80px; background-color: var(--input-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; font-family: inherit; font-size: 1rem; resize: vertical; }
        .finish-button { display: block; width: 100%; padding: 1rem; font-size: 1.2rem; font-weight: bold; margin-top: 1rem; background-color: var(--accent-color); color: var(--primary-color); border: none; border-radius: 8px; cursor: pointer; }
        .finish-button:hover { opacity: 0.9; }

        /* Estilos do Modal (mantidos) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.85); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: var(--secondary-color); margin: auto; padding: 2rem; border: 1px solid #888; width: 95%; max-width: 800px; border-radius: 10px; position: relative; }
        .close-button { color: #aaa; position: absolute; top: 10px; right: 20px; font-size: 28px; font-weight: bold; cursor: pointer; z-index: 1010; }
        .modal-tabs { display: flex; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
        .modal-tab-button { background: none; border: none; color: var(--text-color); padding: 1rem; font-size: 1rem; cursor: pointer; border-bottom: 3px solid transparent; }
        .modal-tab-button.active { border-bottom-color: var(--accent-color); font-weight: bold; }
        .modal-view { display: none; } .modal-view.active { display: block; }
        .chart-controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center; }
        .chart-controls select { padding: 0.5rem; background-color: var(--input-bg); color: var(--text-color); border: 1px solid #555; border-radius: 5px; }
        #history-manager, #pr-manager { max-height: 400px; overflow-y: auto; }
        .history-manager-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem; }
        .data-io-button { padding: 0.5rem 1rem; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        .export-button { background-color: var(--success-color); color: white; }
        .import-button { background-color: var(--info-color); color: white; }
        .history-item, .pr-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .history-item-info, .pr-item-info { font-size: 0.9rem; }
        .history-item-info strong, .pr-item-info strong { color: var(--accent-color); }
        .pr-item-details { color: var(--pr-color); font-weight: bold; }
        .history-item-notes { font-style: italic; color: #aaa; font-size: 0.85rem; margin-top: 5px; max-width: 80%; }
        .delete-btn { background: transparent; border: none; color: var(--danger-color); font-size: 1.5rem; cursor: pointer; }
        #consistency-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
        .calendar-header { text-align: center; font-weight: bold; font-size: 0.8rem; }

        /* --- ESTILO: PREENCHIMENTO COMPLETO --- */
        .calendar-day { 
            background-color: var(--calendar-day-bg); 
            height: 40px; border-radius: 5px; 
            transition: background-color 0.2s, opacity 0.2s; 
            position: relative; 
            cursor: default; 
        }
        .calendar-day.has-data:hover { opacity: 0.8; } /* Efeito de hover nos dias preenchidos */
        .calendar-day span { 
            position: absolute; top: 5px; left: 5px; font-size: 0.7rem; 
            transition: color 0.2s; /* Adicionar transi√ß√£o para cor do texto */
        }
        
        /* Cores de preenchimento */
        .calendar-day.upper-only { background-color: var(--calendar-upper-color); }
        .calendar-day.lower-only { background-color: var(--calendar-lower-color); }
        
        /* Gradiente para dias com Upper e Lower (Mixed) */
        .calendar-day.mixed { 
            background: linear-gradient(45deg, var(--calendar-upper-color) 50%, var(--calendar-lower-color) 50%); 
        }

        /* Cor do n√∫mero do dia branca para contraste */
        .calendar-day.upper-only span, 
        .calendar-day.lower-only span, 
        .calendar-day.mixed span { 
            color: white; 
            font-weight: bold; 
        }
        /* --- FIM NOVO ESTILO --- */

		.focus-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9);
            z-index: 998; display: none;
        }
        .focus-overlay.active { display: block; }
        .exercise-card.in-focus {
            position: relative; z-index: 999; border: 2px solid var(--pr-color);
        }
        .focus-button {
            background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer;
            opacity: 0.6; transition: opacity 0.2s;
        }
        .focus-button:hover { opacity: 1; }

        /* Melhoria: Estilos para Toast Message */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 2000;
        }
        .toast {
            background-color: var(--secondary-color); color: var(--text-color); padding: 10px 20px;
            border-radius: 8px; margin-bottom: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            opacity: 0; transform: translateX(100%); transition: opacity 0.4s ease, transform 0.4s ease;
            min-width: 250px; border-left: 5px solid var(--accent-color);
        }
        .toast.show {
            opacity: 1; transform: translateX(0);
        }
        .toast-success { border-left-color: var(--success-color); }
        .toast-error { border-left-color: var(--danger-color); }
        .toast-warning { border-left-color: var(--warning-color); }

    </style>
</head>
<body>
    <div class="container">
	    <div id="deload-notice-container"></div>
        <div class="header-container">
            <h1>Plano de Treino</h1>
            <button class="theme-switcher" id="theme-switcher">üåô</button>
        </div>
        <div class="main-controls" style="margin-top: 2rem;">
            <button class="main-button" onclick="openChartModal()">Ver Evolu√ß√£o</button>
        </div>
        <div class="workout-selector">
            <button class="tab-button active" onclick="showWorkout('UpperA')">Superiores A</button>
            <button class="tab-button" onclick="showWorkout('LowerA')">Inferiores A</button>
            <button class="tab-button" onclick="showWorkout('UpperB')">Superiores B</button>
            <button class="tab-button" onclick="showWorkout('LowerB')">Inferiores B</button>
        </div>
        <div id="workout-UpperA" class="workout-plan active"></div>
        <div id="workout-LowerA" class="workout-plan"></div>
        <div id="workout-UpperB" class="workout-plan"></div>
        <div id="workout-LowerB" class="workout-plan"></div>
    </div>
    
    <div id="toast-container"></div>

    <div id="chartModal" class="modal"></div>
    <input type="file" id="import-file-input" accept=".json" style="display: none;">
<script>
    const workouts = {
        UpperA: [
            { name: 'Supino Reto com Barra', sets: 4, reps: '6-8', rest: 150, targetMuscle: 'Peito' }, 
            { name: 'Crucifixo Inclinado com Halteres', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Peito' },
            { name: 'Desenvolvimento Militar', sets: 3, reps: '8-10', rest: 120, targetMuscle: 'Ombros' }, 
            { name: 'Eleva√ß√£o Frontal com Halteres', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Ombros' },
            { name: 'Remada Curvada', sets: 4, reps: '6-8', rest: 120, targetMuscle: 'Costas' }, 
            { name: 'Rosca Direta com Barra', sets: 3, reps: '8-10', rest: 90, targetMuscle: 'B√≠ceps' },
            { name: 'Tr√≠ceps Testa', sets: 3, reps: '8-10', rest: 90, targetMuscle: 'Tr√≠ceps' },
        ],
        LowerA: [
            { name: 'Agachamento Livre', sets: 4, reps: '6-8', rest: 180, targetMuscle: 'Pernas' }, 
            { name: 'Leg Press 45¬∫', sets: 3, reps: '8-10', rest: 120, targetMuscle: 'Pernas' },
            { name: 'Levantamento Terra Romeno', sets: 4, reps: '8-10', rest: 120, targetMuscle: 'Posteriores' }, 
            { name: 'Cadeira Flexora', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Posteriores' },
            { name: 'Panturrilha em P√©', sets: 5, reps: '10-15', rest: 60, targetMuscle: 'Panturrilhas' },
        ],
        UpperB: [
            { name: 'Barra Fixa (ou Puxada Frontal)', sets: 4, reps: '6-8', rest: 120, targetMuscle: 'Costas' }, 
            { name: 'Remada Cavalinho', sets: 3, reps: '8-10', rest: 120, targetMuscle: 'Costas' },
            { name: 'Supino Inclinado com Halteres', sets: 4, reps: '8-10', rest: 120, targetMuscle: 'Peito' }, 
            { name: 'Cross Over Polia Alta', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Peito' },
            { name: 'Eleva√ß√£o Lateral com Halteres', sets: 4, reps: '10-15', rest: 90, targetMuscle: 'Ombros' }, 
            { name: 'Crucifixo Invertido (Bent-Over)', sets: 3, reps: '12-15', rest: 90, targetMuscle: 'Ombros' },
            { name: 'Tr√≠ceps Corda', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Tr√≠ceps' }, 
            { name: 'Tr√≠ceps Franc√™s com Halter', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Tr√≠ceps' },
            { name: 'Rosca Martelo', sets: 3, reps: '8-10', rest: 90, targetMuscle: 'B√≠ceps' }, 
            { name: 'Rosca Inclinada com Halteres', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'B√≠ceps' },
        ],
        LowerB: [
            { name: 'Agachamento Livre', sets: 3, reps: '5-6', rest: 180, targetMuscle: 'Posteriores' }, 
            { name: 'Levantamento Terra Convencional', sets: 4, reps: '8-10', rest: 120, targetMuscle: 'Gl√∫teos' },
            { name: 'Afundo com Halteres', sets: 4, reps: '8-10', rest: 120, targetMuscle: 'Pernas' }, 
            { name: 'Cadeira Extensora', sets: 3, reps: '10-12', rest: 90, targetMuscle: 'Pernas' },
            { name: 'Panturrilha Sentado', sets: 5, reps: '15-20', rest: 60, targetMuscle: 'Panturrilhas' },
        ]
    };

    const VARIATION_THRESHOLD = 12; 
    const WORKOUT_NAMES = {
        UpperA: "Superiores A", LowerA: "Inferiores A", UpperB: "Superiores B", LowerB: "Inferiores B"
    };

    // FUN√á√ÉO MELHORADA: TOAST MESSAGE
    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.textContent = message;

        container.appendChild(toast);
        
        // Exibir
        setTimeout(() => toast.classList.add('show'), 10);

        // Esconder
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 500); // Remover ap√≥s a transi√ß√£o
        }, duration);
    }

    // L√ìGICA PARA O MODO FOCO (Mantida)
    let focusOverlay;
    function createFocusOverlay() {
        if (document.getElementById('focus-overlay')) return;
        focusOverlay = document.createElement('div');
        focusOverlay.id = 'focus-overlay';
        focusOverlay.className = 'focus-overlay';
        focusOverlay.onclick = () => toggleFocus(null, true);
        document.body.appendChild(focusOverlay);
    }
    function toggleFocus(button, forceOff = false) {
        const activeCard = document.querySelector('.exercise-card.in-focus');
        if (forceOff || activeCard) {
            if(activeCard) activeCard.classList.remove('in-focus');
            focusOverlay.classList.remove('active');
            document.body.style.overflow = 'auto';
        } else {
            const card = button.closest('.exercise-card');
            card.classList.add('in-focus');
            focusOverlay.classList.add('active');
            document.body.style.overflow = 'hidden'; 
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }


    function getHistory() {
        const history = JSON.parse(localStorage.getItem('workoutHistory')) || [];
        return history.map(workout => ({
            ...workout,
            date: new Date(workout.date) 
        }));
    }

    function calculateWorkoutTime(workout) {
        const timePerSet = 45, timeBetweenExercises = 90; let totalTime = 0;
        workout.forEach(ex => { totalTime += ex.sets * timePerSet + (ex.sets - 1) * ex.rest + timeBetweenExercises; });
        return Math.round(totalTime / 60);
    }

    function getPersonalRecord(exerciseName) {
        const history = getHistory();
        let maxWeight = 0;
        history.forEach(w => w.exercises.forEach(ex => {
            if (ex.name === exerciseName) { 
                const currentMax = Math.max(0, ...ex.sets.map(s => s.weight)); 
                if (currentMax > maxWeight) maxWeight = currentMax; 
            }
        }));
        return maxWeight;
    }

    function getSuggestedWeight(exerciseName) {
        const lastWeight = getPersonalRecord(exerciseName);
        if (!lastWeight) return 'kg';
        const suggestedIncrease = Math.max(lastWeight * 0.05, 2.5);
        let suggestedWeight = lastWeight + suggestedIncrease;
        suggestedWeight = Math.round(suggestedWeight * 2) / 2;
        return `Sug: ${suggestedWeight}kg`;
    }

    // FUN√á√ÉO DE CRIA√á√ÉO DE EXERC√çCIO (MELHORADA COM REPS E CORES)
    function createExerciseHTML(exercise) {
        const pr = getPersonalRecord(exercise.name);
        const prBadge = pr > 0 ? `<span class="pr-badge">üèÜ PR: ${pr}kg</span>` : '';
        const placeholder = getSuggestedWeight(exercise.name);
        
        // Define o valor inicial de reps como o limite superior ou o valor √∫nico
        const defaultReps = exercise.reps.split('-').pop();

        let tableRows = '';
        for (let i = 1; i <= exercise.sets; i++) {
            tableRows += `
                <tr class="set-row">
                    <td>${i}</td>
                    <td><input type="number" class="input-field weight-input" placeholder="${placeholder}" onblur="autoCompleteSet(this)"></td>
                    <td><input type="number" class="input-field reps-input" value="${defaultReps}" onblur="autoCompleteSet(this)" min="1"></td>
                    <td><input type="checkbox" class="set-checkbox" onchange="toggleSetCompleted(this)"></td>
                </tr>
            `;
        }
        
        return `
            <div class="exercise-card" data-exercise-name="${exercise.name}" data-muscle="${exercise.targetMuscle}">
                <div class="exercise-header">
                    <div>
                        <h3 class="exercise-title">${exercise.name}${prBadge}</h3>
                        <p class="exercise-meta">${exercise.sets} s√©ries x ${exercise.reps} reps (${exercise.targetMuscle})</p>
                    </div>
                    <div>
                        <button class="focus-button" onclick="toggleFocus(this)">üëÅÔ∏è</button>
                        <button class="timer-button" onclick="startTimer(this, ${exercise.rest})">
                            Iniciar Descanso
                        </button>
                        <div class="timer-rest-info">(${exercise.rest}s)</div>
                    </div>
                </div>
                <table class="sets-table">
                    <thead>
                        <tr>
                            <th>S√©rie</th>
                            <th>Peso (kg)</th>
                            <th>Reps</th>
                            <th>Feito ‚úî</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
            </div>
        `;
    }
    
    // FUN√á√ÉO MELHORADA: Autocompletar s√©rie ao sair dos campos de input
    function autoCompleteSet(input) {
        const row = input.closest('.set-row');
        const weightInput = row.querySelector('.weight-input');
        const repsInput = row.querySelector('.reps-input');
        const checkbox = row.querySelector('.set-checkbox');

        // Se o peso e as reps forem preenchidos, marca o checkbox (Usabilidade)
        if (weightInput.value.trim() !== '' && repsInput.value.trim() !== '') {
            checkbox.checked = true;
            toggleSetCompleted(checkbox);
        } else {
            // Se o peso ou reps forem esvaziados, desmarca
            if (checkbox.checked) {
                checkbox.checked = false;
                toggleSetCompleted(checkbox);
            }
        }
    }

    function toggleSetCompleted(checkbox) { 
        checkbox.closest('.set-row').classList.toggle('completed', checkbox.checked); 
    }

    function renderWorkouts() {
        const history = getHistory();
        for (const workoutId in workouts) {
            const container = document.getElementById(`workout-${workoutId}`);
            if (!container) continue;

            const workoutSessionCount = history.filter(w => w.workoutId === workoutId).length;
            let variationNoticeHTML = '';
            if (workoutSessionCount >= VARIATION_THRESHOLD) {
                variationNoticeHTML = `<div class="variation-notice">üß† **Hora de Variar?** Voc√™ j√° fez este treino ${workoutSessionCount} vezes. Considere trocar alguns exerc√≠cios para continuar progredindo.</div>`;
            }

            const time = calculateWorkoutTime(workouts[workoutId]);
            let html = `${variationNoticeHTML}<div class="workout-header"><h2>${WORKOUT_NAMES[workoutId] || workoutId}</h2><p class="workout-meta">‚è±Ô∏è Tempo Estimado: ~${time} minutos</p><button class="secondary-button" onclick="fillFromLastWorkout('${workoutId}')">Preencher com √öltimo Treino</button></div>`;
            workouts[workoutId].forEach(ex => { html += createExerciseHTML(ex); });

			html += `<div class="notes-section"><label for="notes-${workoutId}"><h3>Notas do Treino</h3></label><textarea id="notes-${workoutId}" placeholder="Como se sentiu hoje? Alguma dor? O treino rendeu?"></textarea></div>`;
            html += `<button class="finish-button" onclick="saveWorkout('${workoutId}')">Finalizar e Salvar Treino</button>`;
            container.innerHTML = html;
        }
        
        // Estrutura do Modal Atualizada com a nova se√ß√£o de Evolu√ß√£o por Grupo Muscular
        document.getElementById('chartModal').innerHTML = `<div class="modal-content"><span class="close-button" onclick="closeChartModal()">&times;</span><div class="modal-tabs"><button class="modal-tab-button active" onclick="showModalView('evolution')">Evolu√ß√£o</button><button class="modal-tab-button" onclick="showModalView('balance')">Balan√ßo</button><button class="modal-tab-button" onclick="showModalView('consistency')">Consist√™ncia</button><button class="modal-tab-button" onclick="showModalView('records')">Recordes</button><button class="modal-tab-button" onclick="showModalView('history')">Hist√≥rico</button></div><div id="evolution-view" class="modal-view active"><h3 style="text-align:center;">Evolu√ß√£o por Exerc√≠cio</h3><div class="chart-controls"><select id="exerciseSelector"></select><select id="periodSelector"><option value="30">1 M√™s</option><option value="90">3 Meses</option><option value="180">6 Meses</option><option value="365">1 Ano</option></select><select id="chartTypeSelector"><option value="bar">Barras</option><option value="line">Linhas</option></select></div><canvas id="evolutionChart"></canvas><h3 style="text-align:center; margin-top: 2rem;">Evolu√ß√£o por Grupo Muscular</h3><div class="chart-controls"><select id="muscleGroupSelector"></select><select id="musclePeriodSelector"><option value="30">1 M√™s</option><option value="90">3 Meses</option><option value="180">6 Meses</option><option value="365">1 Ano</option></select><select id="muscleChartTypeSelector"><option value="bar">Barras</option><option value="line">Linhas</option></select></div><canvas id="muscleEvolutionChart"></canvas></div><div id="balance-view" class="modal-view"><h3 style="text-align:center;">Balan√ßo Muscular (Volume Total)</h3><canvas id="balanceChart"></canvas></div><div id="consistency-view" class="modal-view"><h3 style="text-align:center;">Frequ√™ncia de Treinos</h3><div id="consistency-calendar"></div></div><div id="records-view" class="modal-view"><div id="pr-manager"></div></div><div id="history-view" class="modal-view"><div id="history-manager"></div></div></div>`;
    }

    // FUN√á√ÉO MELHORADA: fillFromLastWorkout usando Toast
    function fillFromLastWorkout(workoutId) {
        const history = getHistory();
        const lastWorkout = history.slice().reverse().find(w => w.workoutId === workoutId);
        if (!lastWorkout) {
            showToast(`Nenhum treino anterior do tipo "${WORKOUT_NAMES[workoutId] || workoutId}" foi encontrado.`, 'warning');
            return;
        }

        const workoutContainer = document.getElementById(`workout-${workoutId}`);
        lastWorkout.exercises.forEach(ex => {
            const card = workoutContainer.querySelector(`.exercise-card[data-exercise-name="${ex.name}"]`);
            if (card) {
                const rows = card.querySelectorAll('.set-row');
                ex.sets.forEach((set, index) => {
                    const row = rows[index];
                    if (row) {
                        row.querySelector('.weight-input').value = set.weight;
                        row.querySelector('.reps-input').value = set.reps; // Preenche as reps
                        // Auto-marca a s√©rie
                        const checkbox = row.querySelector('.set-checkbox');
                        checkbox.checked = true;
                        toggleSetCompleted(checkbox);
                    }
                });
            }
        });
        showToast('Pesos e repeti√ß√µes preenchidos com base no √∫ltimo treino.', 'success');
    }

    function showWorkout(id) {
        document.querySelectorAll('.workout-plan').forEach(p => p.classList.remove('active'));
        document.getElementById(`workout-${id}`).classList.add('active');
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.tab-button[onclick="showWorkout('${id}')"]`).classList.add('active');
    }

    let timerInterval;
    const notificationSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('12121212'));

    function startTimer(button, duration) {
        if (button.classList.contains('timing')) return;
        button.classList.add('timing'); 
        let timeLeft = duration;
        
        const originalText = 'Iniciar Descanso';
        const restInfo = button.nextElementSibling; // O div.timer-rest-info

        timerInterval = setInterval(() => {
            timeLeft--; 
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            button.textContent = `Descansando... ${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
            
            if (timeLeft <= 0) {
                clearInterval(timerInterval); 
                button.classList.remove('timing');
                button.textContent = originalText;
                notificationSound.play(); 
                if (navigator.vibrate) navigator.vibrate(200);
                showToast('Descanso finalizado! Pr√≥xima s√©rie.', 'info', 5000);
            }
        }, 1000);
    }
    
    // FUN√á√ÉO MELHORADA: saveWorkout (usa Reps e Toast)
    function saveWorkout(workoutId) {
        const notes = document.getElementById(`notes-${workoutId}`).value;
        const workoutData = { date: new Date().toISOString(), workoutId: workoutId, exercises: [], notes: notes };
        const container = document.getElementById(`workout-${workoutId}`);
        let newPrs = [];
        container.querySelectorAll('.exercise-card').forEach(card => {
            const name = card.dataset.exerciseName;
            const sets = []; 
            let maxWeightInWorkout = 0;
            
            card.querySelectorAll('.set-row').forEach(row => {
                const isChecked = row.querySelector('.set-checkbox').checked;
                const weightInput = row.querySelector('.weight-input').value;
                const repsInput = row.querySelector('.reps-input').value; // Pega o valor de Reps
                
                if (isChecked && weightInput && repsInput) {
                    const w = parseFloat(weightInput);
                    const r = parseInt(repsInput);
                    sets.push({ weight: w, reps: r }); // Salva Reps vari√°veis
                    if (w > maxWeightInWorkout) maxWeightInWorkout = w;
                }
            });
            
            if (sets.length > 0) {
                workoutData.exercises.push({ name: name, sets: sets });
                const oldPr = getPersonalRecord(name);
                if (maxWeightInWorkout > oldPr) newPrs.push({ name, weight: maxWeightInWorkout });
            }
        });
        
        if (workoutData.exercises.length === 0) { 
            showToast("Nenhum dado para salvar. Preencha pelo menos uma s√©rie.", 'warning'); 
            return; 
        }
        
        let history = getHistory();
        history.push(workoutData);
        localStorage.setItem('workoutHistory', JSON.stringify(history));
        
        let alertMessage = `Treino salvo com sucesso!`;
        if (newPrs.length > 0) {
            newPrs.forEach(pr => {
                showToast(`üèÜ NOVO PR! ${pr.name}: ${pr.weight}kg. Parab√©ns!`, 'pr', 8000);
            });
        }
        showToast(alertMessage, 'success');

        renderWorkouts(); showWorkout(workoutId);
    }

    const chartModal = document.getElementById('chartModal');
    let evolutionChart;
    let muscleEvolutionChart; // NOVO: Vari√°vel global para o gr√°fico de evolu√ß√£o muscular
    const allWorkoutExercises = Object.values(workouts).flat(); // Auxiliar para buscar info de m√∫sculo

    function openChartModal() {
        chartModal.classList.add('show');
        showModalView('evolution');
        
        // Listeners para Evolu√ß√£o por Exerc√≠cio (Existente)
        document.getElementById('exerciseSelector').onchange = updateChart;
        document.getElementById('periodSelector').onchange = updateChart;
        document.getElementById('chartTypeSelector').onchange = updateChart;
        
        // Listeners para Evolu√ß√£o por Grupo Muscular (Novo)
        document.getElementById('muscleGroupSelector').onchange = updateMuscleEvolutionChart;
        document.getElementById('musclePeriodSelector').onchange = updateMuscleEvolutionChart;
        document.getElementById('muscleChartTypeSelector').onchange = updateMuscleEvolutionChart;

        populateExerciseSelector();
        populateMuscleGroupSelector(); // Chamada para popular novo seletor
        updateChart();
        updateMuscleEvolutionChart(); // Chamada inicial para o novo gr√°fico
    }
    function closeChartModal() { chartModal.classList.remove('show'); }

    function showModalView(viewId) {
        document.querySelectorAll('.modal-view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewId}-view`).classList.add('active');
        document.querySelectorAll('.modal-tab-button').forEach(b => b.classList.remove('active'));
        document.querySelector(`.modal-tab-button[onclick="showModalView('${viewId}')"]`).classList.add('active');

        // Melhoria: Carregamento sob demanda para performance
        if (viewId === 'evolution') { 
            updateChart(); 
            updateMuscleEvolutionChart(); // Garante que o novo gr√°fico tamb√©m seja atualizado ao abrir a aba
        }
		if (viewId === 'balance') updateBalanceChart();
        if (viewId === 'consistency') renderConsistencyCalendar();
        if (viewId === 'records') renderPrList();
        if (viewId === 'history') renderHistoryList();
    }

    // --- FUN√á√ÉO MODIFICADA PARA ORDENA√á√ÉO ALFAB√âTICA (Renomeada) ---
    function populateExerciseSelector() { // Renomeado de populateSelectors
        const history = getHistory();
        // 1. Coleta os nomes √∫nicos dos exerc√≠cios
        const exSet = new Set(history.flatMap(w => w.exercises.map(e => e.name)));
        
        // 2. Converte para Array e ordena em ordem alfab√©tica (usando localeCompare para PT-BR)
        const sortedExercises = Array.from(exSet).sort((a, b) => a.localeCompare(b, 'pt-BR'));
        
        const selector = document.getElementById('exerciseSelector');
        
        // 3. Popula com a lista ordenada
        if (sortedExercises.length === 0) {
            selector.innerHTML = "<option>Nenhum treino salvo</option>";
        } else {
            selector.innerHTML = "";
            sortedExercises.forEach(name => selector.innerHTML += `<option value="${name}">${name}</option>`);
        }
    }
    // --- FIM DA FUN√á√ÉO MODIFICADA ---
    
    // --- NOVA FUN√á√ÉO: Popular Seletor de M√∫sculos ---
    function populateMuscleGroupSelector() {
        const muscleSet = new Set(allWorkoutExercises.map(ex => ex.targetMuscle));
        const sortedMuscles = Array.from(muscleSet).sort((a, b) => a.localeCompare(b, 'pt-BR'));
        const selector = document.getElementById('muscleGroupSelector');

        if (sortedMuscles.length === 0) {
            selector.innerHTML = "<option>Nenhum m√∫sculo encontrado</option>";
        } else {
            selector.innerHTML = "";
            sortedMuscles.forEach(name => selector.innerHTML += `<option value="${name}">${name}</option>`);
        }
    }
    // --- FIM DA NOVA FUN√á√ÉO ---

    function updateChart() {
        const history = getHistory();
        const selEx = document.getElementById('exerciseSelector').value;
        const selPeriod = parseInt(document.getElementById('periodSelector').value);
        const chartType = document.getElementById('chartTypeSelector').value;
        if (!selEx || history.length === 0) { if (evolutionChart) evolutionChart.destroy(); return; }
        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - selPeriod);
        const filtered = history.filter(w => w && w.date && new Date(w.date) >= cutoff).map(w => {
            const ex = w.exercises.find(e => e.name === selEx); if (!ex) return null;
            // C√°lculo de Volume e Carga M√°xima usando Reps vari√°veis
            const vol = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
            const maxW = Math.max(0, ...ex.sets.map(set => set.weight));
            return { date: new Date(w.date).toLocaleDateString('pt-BR'), vol, maxW };
        }).filter(Boolean);
        const labels = [...new Set(filtered.map(d => d.date))];
        const volData = [], weightData = [];
        labels.forEach(label => {
            const dayData = filtered.filter(d => d.date === label);
            if (dayData.length > 0) {
                // Para volume, somamos os volumes do mesmo exerc√≠cio no dia (se houver mais de um treino)
                volData.push(dayData.reduce((sum, item) => sum + item.vol, 0));
                // Para carga m√°xima, pegamos a maior carga do dia para aquele exerc√≠cio
                weightData.push(Math.max(...dayData.map(item => item.maxW)));
            }
        });
        const ctx = document.getElementById('evolutionChart').getContext('2d');
        if (evolutionChart) evolutionChart.destroy();
        evolutionChart = new Chart(ctx, {
            type: chartType, data: { labels, datasets: [
                { label: `Volume Total (Kg)`, data: volData, borderColor: 'rgba(0, 123, 255, 1)', backgroundColor: 'rgba(0, 123, 255, 0.5)', yAxisID: 'yVolume' },
                { label: `Carga M√°xima (Kg)`, data: weightData, borderColor: 'rgba(40, 167, 69, 1)', backgroundColor: 'rgba(40, 167, 69, 0.5)', yAxisID: 'yWeight' }
            ]},
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: { color: 'var(--text-color)' } },
                    yVolume: { type: 'linear', display: true, position: 'left', ticks: { color: 'rgba(0, 123, 255, 1)' }, beginAtZero: true, title: { display: true, text: 'Volume Total', color: 'rgba(0, 123, 255, 1)'} },
                    yWeight: { type: 'linear', display: true, position: 'right', ticks: { color: 'rgba(40, 167, 69, 1)' }, beginAtZero: true, title: { display: true, text: 'Carga M√°xima', color: 'rgba(40, 167, 69, 1)'}, grid: { drawOnChartArea: false } }
                },
                plugins: { legend: { labels: { color: 'var(--text-color)' } } }
            }
        });
    }

    // --- NOVA FUN√á√ÉO: Gr√°fico de Evolu√ß√£o por Grupo Muscular ---
    function updateMuscleEvolutionChart() {
        const history = getHistory();
        const selMuscle = document.getElementById('muscleGroupSelector').value;
        const selPeriod = parseInt(document.getElementById('musclePeriodSelector').value);
        const chartType = document.getElementById('muscleChartTypeSelector').value;

        if (!selMuscle || history.length === 0) { if (muscleEvolutionChart) muscleEvolutionChart.destroy(); return; }

        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - selPeriod);
        const dailyData = {}; 

        history.filter(w => w && w.date && new Date(w.date) >= cutoff).forEach(w => {
            const dateStr = new Date(w.date).toLocaleDateString('pt-BR');
            
            w.exercises.forEach(ex => {
                const exInfo = allWorkoutExercises.find(info => info.name === ex.name);
                
                if (exInfo && exInfo.targetMuscle === selMuscle) {
                    const dailyEntry = dailyData[dateStr] || { totalVolume: 0, maxWeights: [] };
                    
                    const volume = ex.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0);
                    const maxW = Math.max(0, ...ex.sets.map(set => set.weight));
                    
                    dailyEntry.totalVolume += volume; // Soma o volume de todos os exerc√≠cios do m√∫sculo no dia
                    dailyEntry.maxWeights.push(maxW); // Coleciona as cargas m√°ximas de cada exerc√≠cio do m√∫sculo no dia
                    
                    dailyData[dateStr] = dailyEntry;
                }
            });
        });

        const sortedDates = Object.keys(dailyData).sort((a, b) => {
            const parseDate = (dateStr) => {
                const [day, month, year] = dateStr.split('/');
                return new Date(year, month - 1, day);
            };
            return parseDate(a) - parseDate(b);
        });
        
        const labels = sortedDates;
        const volData = sortedDates.map(date => dailyData[date].totalVolume);
        const maxWeightData = sortedDates.map(date => Math.max(0, ...dailyData[date].maxWeights)); // A maior carga de QUALQUER exerc√≠cio do grupo no dia

        const ctx = document.getElementById('muscleEvolutionChart').getContext('2d');
        if (muscleEvolutionChart) muscleEvolutionChart.destroy();
        
        muscleEvolutionChart = new Chart(ctx, {
            type: chartType, 
            data: { 
                labels, 
                datasets: [
                    { 
                        label: `Volume Total ${selMuscle} (Kg)`, 
                        data: volData, 
                        borderColor: 'rgba(249, 177, 21, 1)', 
                        backgroundColor: 'rgba(249, 177, 21, 0.5)', 
                        yAxisID: 'yVolume' 
                    },
                    { 
                        label: `Carga M√°xima (Kg) do Grupo`, 
                        data: maxWeightData, 
                        borderColor: 'rgba(255, 0, 0, 1)', 
                        backgroundColor: 'rgba(255, 0, 0, 0.5)', 
                        yAxisID: 'yWeight' 
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { ticks: { color: 'var(--text-color)' } },
                    yVolume: { type: 'linear', display: true, position: 'left', ticks: { color: 'rgba(249, 177, 21, 1)' }, beginAtZero: true, title: { display: true, text: 'Volume Total', color: 'rgba(249, 177, 21, 1)'} },
                    yWeight: { type: 'linear', display: true, position: 'right', ticks: { color: 'rgba(255, 0, 0, 1)' }, beginAtZero: true, title: { display: true, text: 'Carga M√°xima do Grupo', color: 'rgba(255, 0, 0, 1)'}, grid: { drawOnChartArea: false } }
                },
                plugins: { legend: { labels: { color: 'var(--text-color)' } } }
            }
        });
    }
    // --- FIM DA NOVA FUN√á√ÉO ---


    // MELHORIA APLICADA ANTERIORMENTE: Mapeamento de Cores para Gr√°fico de Balan√ßo
    const MUSCLE_COLORS = {
        'Peito': 'rgba(220, 53, 69, 0.7)',       // Cor: --muscle-chest (#dc3545)
        'Ombros': 'rgba(255, 193, 7, 0.7)',      // Cor: --muscle-shoulders (#ffc107)
        'Costas': 'rgba(0, 123, 255, 0.7)',      // Cor: --muscle-back (#007bff)
        'B√≠ceps': 'rgba(40, 167, 69, 0.7)',      // Cor: --muscle-biceps (#28a745)
        'Tr√≠ceps': 'rgba(23, 162, 184, 0.7)',    // Cor: --muscle-triceps (#17a2b8)
        'Pernas': 'rgba(249, 177, 21, 0.7)',     // Cor: --muscle-legs (#f9b115)
        'Gl√∫teos': 'rgba(156, 39, 176, 0.7)',    // Cor: --muscle-glutes (#9c27b0)
        'Posteriores': 'rgba(139, 195, 74, 0.7)',// Cor: --muscle-hamstrings (#8bc34a)
        'Panturrilhas': 'rgba(96, 125, 139, 0.7)'// Cor: --muscle-calves (#607d8b)
    };

    let balanceChart;
    function updateBalanceChart() {
        const history = getHistory();
        // O per√≠odo de tempo ainda √© definido pelo selector da aba Evolu√ß√£o (periodSelector)
        // Usamos o selector de per√≠odo do gr√°fico de exerc√≠cio como base.
        const selPeriod = parseInt(document.getElementById('periodSelector').value); 
        if (history.length === 0) { if (balanceChart) balanceChart.destroy(); return; }

        const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - selPeriod);
        const volumeByMuscle = {};
        const allMuscles = new Set(Object.values(workouts).flat().map(ex => ex.targetMuscle));
        allMuscles.forEach(m => volumeByMuscle[m] = 0);
        const filteredHistory = history.filter(w => w.date >= cutoff);

        filteredHistory.forEach(workout => {
            workout.exercises.forEach(exercise => {
                const exerciseInfo = allWorkoutExercises.find(ex => ex.name === exercise.name);
                if (exerciseInfo && exerciseInfo.targetMuscle) {
                    const volume = exercise.sets.reduce((sum, set) => sum + (set.weight * set.reps), 0); 
                    volumeByMuscle[exerciseInfo.targetMuscle] += volume;
                }
            });
        });

        // Remove m√∫sculos com volume zero para n√£o poluir o gr√°fico
        const labels = Object.keys(volumeByMuscle).filter(m => volumeByMuscle[m] > 0);
        const data = labels.map(m => volumeByMuscle[m]);

        // Gera as cores do gr√°fico usando o mapeamento padronizado
        const backgroundColors = labels.map(muscle => MUSCLE_COLORS[muscle] || 'rgba(128, 128, 128, 0.7)');

        const ctx = document.getElementById('balanceChart').getContext('2d');
        if (balanceChart) balanceChart.destroy();
        
        // --- APLICA√á√ÉO DA MELHORIA: Gr√°fico de Barras ---
        balanceChart = new Chart(ctx, {
            type: 'bar', // Tipo alterado para 'bar'
            data: {
                labels: labels,
                datasets: [{
                    label: 'Volume Total (Kg)',
                    data: data,
                    backgroundColor: backgroundColors,
                    borderColor: 'var(--secondary-color)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y', // Barras horizontais para melhor visualiza√ß√£o dos nomes
                plugins: {
                    legend: { display: false }, // Legenda n√£o √© necess√°ria para barras de cor √∫nica
                    title: {
                        display: true,
                        text: `Balan√ßo Muscular (Volume em Kg) nos √öltimos ${selPeriod} Dias`,
                        color: 'var(--text-color)'
                    }
                },
                scales: {
                    x: { // Eixo X para o Volume (Kg)
                        beginAtZero: true,
                        title: { display: true, text: 'Volume Total (Kg)', color: 'var(--text-color)' },
                        ticks: { color: 'var(--text-color)' },
                        grid: { color: 'rgba(68, 68, 68, 0.3)' }
                    },
                    y: { // Eixo Y para os M√∫sculos
                        ticks: { color: 'var(--text-color)' },
                        grid: { display: false }
                    }
                }
            }
        });
        // --- FIM DA MELHORIA ---
    }

	function checkForDeloadSuggestion() {
        const history = getHistory();
        if (history.length < 21) return;

        const today = new Date();
        const fourWeeksAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 28);
        const recentHistory = history.filter(w => w.date >= fourWeeksAgo);
        if (recentHistory.length < 9) return;

        const getWeekNumber = (d) => {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        };

        const volumeByWeek = {};
        recentHistory.forEach(workout => {
            const week = `${workout.date.getFullYear()}-${getWeekNumber(workout.date)}`;
            const workoutVolume = workout.exercises.reduce((totalVol, ex) => 
                totalVol + ex.sets.reduce((vol, set) => vol + (set.weight * set.reps), 0), 0);
            
            if (!volumeByWeek[week]) volumeByWeek[week] = 0;
            volumeByWeek[week] += workoutVolume;
        });

        const weeklyVolumes = Object.values(volumeByWeek).sort((a, b) => a - b);
        if (weeklyVolumes.length < 3) return;

        const lastWeekVolume = weeklyVolumes[weeklyVolumes.length - 1];
        const peakWeekVolume = Math.max(...weeklyVolumes);
        const isVolumeStagnated = lastWeekVolume <= peakWeekVolume;

        const twoWeeksAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 14);
        let newPrsInLastTwoWeeks = 0;
        const historyBeforeTwoWeeks = recentHistory.filter(w => w.date < twoWeeksAgo);
        const historyLastTwoWeeks = recentHistory.filter(w => w.date >= twoWeeksAgo);

        const prsBefore = {};
        Object.values(workouts).flat().forEach(ex => {
            let maxWeight = 0;
            historyBeforeTwoWeeks.forEach(w => w.exercises.forEach(e => {
                if (e.name === ex.name) {
                    const currentMax = Math.max(0, ...e.sets.map(s => s.weight));
                    if (currentMax > maxWeight) maxWeight = currentMax;
                }
            }));
            prsBefore[ex.name] = maxWeight;
        });

        historyLastTwoWeeks.forEach(w => w.exercises.forEach(e => {
            const prBefore = prsBefore[e.name] || 0;
            const currentMax = Math.max(0, ...e.sets.map(s => s.weight));
            if (currentMax > prBefore) {
                newPrsInLastTwoWeeks++;
            }
        }));
        
        const havePRsStagnated = newPrsInLastTwoWeeks <= 1;

        if (isVolumeStagnated && havePRsStagnated) {
            const noticeContainer = document.getElementById('deload-notice-container');
            const lastNoticeShown = localStorage.getItem('lastDeloadNotice');
            const thirtyDaysAgo = new Date(today.getFullYear(), today.getMonth(), today.getDate() - 30).toISOString();

            if (!lastNoticeShown || lastNoticeShown < thirtyDaysAgo) {
                noticeContainer.innerHTML = `<div class="deload-notice" onclick="this.style.display='none'">üìâ **Sinais de Fadiga?** Seu progresso de volume e for√ßa estagnou. Considere uma semana de *deload* (treinos mais leves).</div>`;
                localStorage.setItem('lastDeloadNotice', today.toISOString());
            }
        }
    }

    // --- FUN√á√ÉO ALTERADA PARA USAR PREENCHIMENTO COMPLETO ---
    function renderConsistencyCalendar() {
        const calendarEl = document.getElementById('consistency-calendar');
        const history = getHistory();
        calendarEl.innerHTML = '';

        const today = new Date();
        const month = today.getMonth();
        const year = today.getFullYear();

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        ['D', 'S', 'T', 'Q', 'Q', 'S', 'S'].forEach(day => {
            const headerEl = document.createElement('div');
            headerEl.className = 'calendar-header';
            headerEl.textContent = day;
            calendarEl.appendChild(headerEl);
        });

        for (let i = 0; i < firstDay; i++) {
            calendarEl.appendChild(document.createElement('div'));
        }

        for (let i = 1; i <= daysInMonth; i++) {
            const dayEl = document.createElement('div');
            dayEl.className = 'calendar-day';
            dayEl.innerHTML = `<span>${i}</span>`; // Removemos o div.workout-dots
            
            const dayWorkouts = history.filter(w => {
                const workoutDate = new Date(w.date);
                return workoutDate.getDate() === i && workoutDate.getMonth() === month && workoutDate.getFullYear() === year;
            });

            if (dayWorkouts.length > 0) {
                dayEl.classList.add('has-data');
                
                // Determina o tipo de treino
                const workoutTypes = new Set(dayWorkouts.map(w => (w.workoutId && w.workoutId.includes('Upper')) ? 'upper' : 'lower'));
                
                const isUpper = workoutTypes.has('upper');
                const isLower = workoutTypes.has('lower');

                // Aplica a classe de cor correspondente
                if (isUpper && isLower) {
                    dayEl.classList.add('mixed');
                } else if (isUpper) {
                    dayEl.classList.add('upper-only');
                } else if (isLower) {
                    dayEl.classList.add('lower-only');
                }
            }
            calendarEl.appendChild(dayEl);
        }
    }
    // --- FIM DA FUN√á√ÉO ALTERADA ---

    function renderHistoryList() {
        const manager = document.getElementById('history-manager');
        const history = getHistory();
        manager.innerHTML = `<div class="history-manager-header"><h3>Hist√≥rico de Treinos</h3><div><button class="data-io-button export-button" onclick="exportData()">Exportar</button><button class="data-io-button import-button" onclick="importData()">Importar</button></div></div>`;
        if (history.length === 0) { manager.innerHTML += '<p>Nenhum treino salvo.</p>'; return; }
        history.slice().reverse().forEach((w, index) => {
            const originalIndex = history.length - 1 - index;
            const date = new Date(w.date).toLocaleDateString('pt-BR', { weekday: 'short', day: '2-digit', month: 'short' });
            const workoutName = WORKOUT_NAMES[w.workoutId] || w.workoutId;
            const notesHTML = w.notes ? `<p class="history-item-notes">Nota: ${w.notes}</p>` : '';
            const item = document.createElement('div');
            item.className = 'history-item';
            item.innerHTML = `<div class="history-item-info"><strong>${date}</strong> - <span>${workoutName}</span>${notesHTML}</div><button class="delete-btn" onclick="deleteWorkout(${originalIndex})">üóëÔ∏è</button>`;
            manager.appendChild(item);
        });
    }

    function renderPrList() {
        const manager = document.getElementById('pr-manager');
        manager.innerHTML = `<h3>üèÜ Recordes Pessoais (PRs)</h3>`;
        const allExercises = new Set(Object.values(workouts).flat().map(ex => ex.name));
        let prsFound = 0;
        const prList = document.createElement('div');
        const history = getHistory();

        // Ordena os exerc√≠cios por nome antes de listar os PRs
        const sortedExerciseNames = Array.from(allExercises).sort((a, b) => a.localeCompare(b, 'pt-BR'));

        sortedExerciseNames.forEach(exName => {
            const pr = getPersonalRecord(exName);
            if (pr > 0) {
                prsFound++;
                const prWorkout = history.slice().reverse().find(w => w.exercises.some(ex => ex.name === exName && ex.sets.some(s => s.weight === pr)));
                const prDate = prWorkout ? new Date(prWorkout.date).toLocaleDateString('pt-BR') : 'N/A';
                const item = document.createElement('div');
                item.className = 'pr-item';
                item.innerHTML = `<div class="pr-item-info"><strong>${exName}</strong></div><div class="pr-item-details">${pr} kg <small>(${prDate})</small></div>`;
                prList.appendChild(item);
            }
        });
        if (prsFound === 0) {
            manager.innerHTML += '<p>Nenhum recorde registrado ainda. Continue treinando!</p>';
        } else {
            manager.appendChild(prList);
        }
    }

    function deleteWorkout(index) {
        let history = getHistory();
        const workoutDate = new Date(history[index].date).toLocaleDateString('pt-BR');
        if (confirm(`Voc√™ tem certeza que deseja deletar o treino do dia ${workoutDate}?`)) {
            history.splice(index, 1);
            localStorage.setItem('workoutHistory', JSON.stringify(history));
            renderWorkouts();
            populateExerciseSelector();
            showModalView('history');
            showToast('Treino deletado com sucesso.', 'info');
        }
    }

    // FUN√á√ÉO MELHORADA: exportData (usa Toast)
    function exportData() {
        const history = localStorage.getItem('workoutHistory');
        if (!history || history === '[]') { 
            showToast('N√£o h√° dados para exportar.', 'warning'); 
            return; 
        }
        const blob = new Blob([history], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'meu_historico_de_treinos.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Hist√≥rico exportado com sucesso!', 'success');
    }

    function importData() { document.getElementById('import-file-input').click(); }

    document.getElementById('import-file-input').addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedHistory = JSON.parse(e.target.result);
                if (!Array.isArray(importedHistory)) throw new Error("Formato inv√°lido.");
                const choice = confirm("Como voc√™ deseja importar os dados?\n\nOK para MESCLAR com os dados existentes.\nCancelar para SUBSTITUIR os dados existentes.");
                if (choice) {
                    const currentHistory = JSON.parse(localStorage.getItem('workoutHistory')) || [];
                    const combinedHistory = [...currentHistory, ...importedHistory];
                    // Remove duplicatas pela data para evitar entradas id√™nticas
                    const uniqueHistory = Array.from(new Map(combinedHistory.map(item => [new Date(item.date).toISOString(), item])).values());
                    localStorage.setItem('workoutHistory', JSON.stringify(uniqueHistory));
                    showToast(`${importedHistory.length} registros mesclados com sucesso!`, 'success');
                } else {
                    if (confirm("ATEN√á√ÉO: Isso apagar√° todos os seus dados atuais. Deseja continuar?")) {
                        localStorage.setItem('workoutHistory', JSON.stringify(importedHistory));
                        showToast(`${importedHistory.length} registros importados com sucesso (substituindo os atuais)!`, 'success');
                    }
                }
                location.reload();
            } catch (error) {
                showToast('Erro ao importar o arquivo. Verifique se o arquivo √© um JSON v√°lido exportado por este aplicativo.', 'error');
            }
        };
        reader.readAsText(file);
        event.target.value = '';
    });

    const themeSwitcher = document.getElementById('theme-switcher');
    const doc = document.documentElement;
    
    function applyTheme(theme) {
        doc.setAttribute('data-theme', theme);
        themeSwitcher.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('theme', theme);
    }

    themeSwitcher.addEventListener('click', () => {
        const currentTheme = doc.getAttribute('data-theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        applyTheme(newTheme);
    });

    window.onclick = function(event) { if (event.target == chartModal) closeChartModal(); }

    document.addEventListener('DOMContentLoaded', () => {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        applyTheme(savedTheme);
		createFocusOverlay();
        renderWorkouts();
		checkForDeloadSuggestion();
        showWorkout('UpperA');
    });
</script>

</body>
</html>
